{
 "creation": "2026-02-11 22:10:00.000000",
 "docstatus": 0,
 "doctype": "Custom HTML Block",
 "html": "<div class=\"dp-kpi-wrap\">\n  <div class=\"dp-kpi-header\">\n    <h3>Revenue &amp; Targets</h3>\n  </div>\n\n  <div class=\"dp-kpi-grid dp-kpi-grid-5\">\n    <div class=\"dp-card\"><div class=\"dp-label\">TOTAL REVENUE</div><div class=\"dp-value dp-green\" data-key=\"revenue\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">TOTAL COLLECTED</div><div class=\"dp-value dp-blue\" data-key=\"collected\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">TOTAL OUTSTANDING</div><div class=\"dp-value dp-orange\" data-key=\"outstanding\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">REVENUE AT RISK</div><div class=\"dp-value\" style=\"color:#b91c1c\" data-key=\"revenue_at_risk\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">MONTHLY TARGET</div><div class=\"dp-value dp-purple\" data-key=\"monthly_target\"></div></div>\n  </div>\n\n  <div class=\"dp-kpi-grid dp-kpi-grid-3\">\n    <div class=\"dp-card\"><div class=\"dp-label\">% TOWARDS TARGET</div><div class=\"dp-value dp-green\" data-key=\"target_pct\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">TOTAL INVOICES</div><div class=\"dp-value dp-purple\" data-key=\"total_invoices\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">OPPORTUNITIES VALUE</div><div class=\"dp-value dp-purple\" data-key=\"opportunities_value\"></div></div>\n  </div>\n\n  <div class=\"dp-kpi-grid dp-kpi-grid-3\">\n    <div class=\"dp-card\"><div class=\"dp-label\">COLLECTION EFFICIENCY (MONTH)</div><div class=\"dp-value dp-green\" data-key=\"collection_efficiency_month\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">COLLECTION EFFICIENCY (ROLLING 3M)</div><div class=\"dp-value dp-blue\" data-key=\"collection_efficiency_3m\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">CASH CONVERSION FLAG</div><div class=\"dp-value dp-status\" data-key=\"cash_conversion_flag\"></div></div>\n  </div>\n\n  <h3 class=\"dp-subhead\">Deals &amp; Pipeline</h3>\n  <div class=\"dp-kpi-grid dp-kpi-grid-4\">\n    <div class=\"dp-card\"><div class=\"dp-label\">TOTAL OPPORTUNITIES</div><div class=\"dp-value dp-blue\" data-key=\"total_opportunities\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">ONGOING DEALS</div><div class=\"dp-value dp-blue\" data-key=\"ongoing_deals\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">WON DEALS</div><div class=\"dp-value dp-green\" data-key=\"won_deals\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">LOST DEALS</div><div class=\"dp-value\" style=\"color:#dc2626\" data-key=\"lost_deals\"></div></div>\n  </div>\n  <div class=\"dp-kpi-grid dp-kpi-grid-4\">\n    <div class=\"dp-card\"><div class=\"dp-label\">AVG. DEAL VALUE</div><div class=\"dp-value dp-purple\" data-key=\"avg_deal_value\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">AVG. WON DEAL VALUE</div><div class=\"dp-value dp-green\" data-key=\"avg_won_deal_value\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">AVG. TIME TO CLOSE DEAL</div><div class=\"dp-value\" style=\"color:var(--text-muted)\" data-key=\"avg_time_to_close_deal\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">AVG. TIME LEAD TO DEAL</div><div class=\"dp-value\" style=\"color:var(--text-muted)\" data-key=\"avg_time_lead_to_deal\"></div></div>\n  </div>\n\n  <h3 class=\"dp-subhead\">Customers</h3>\n  <div class=\"dp-kpi-grid dp-kpi-grid-4\">\n    <div class=\"dp-card\"><div class=\"dp-label\">NEW CUSTOMERS (WEEK)</div><div class=\"dp-value dp-green\" data-key=\"new_customers_week\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">CUSTOMERS SERVED (WEEK)</div><div class=\"dp-value dp-blue\" data-key=\"customers_served_week\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">NEW CUSTOMERS (MONTH)</div><div class=\"dp-value dp-green\" data-key=\"new_customers_month\"></div></div>\n    <div class=\"dp-card\"><div class=\"dp-label\">CUSTOMERS SERVED (MONTH)</div><div class=\"dp-value dp-blue\" data-key=\"customers_served_month\"></div></div>\n  </div>\n</div>",
 "idx": 0,
 "modified": "2026-02-11 22:10:00.000000",
 "modified_by": "Administrator",
 "module": "Sales Performance Dashboard",
 "name": "Department KPI Cards",
 "owner": "Administrator",
 "private": 0,
 "script": "const kpiMethod = \"sales_performance_dashboard.api.department_dashboard_api.get_department_kpis\";\nconst storageKey = 'spd_department_dashboard_department';\nconst riskStorageKey = 'spd_department_risk_window';\nconst storageDate = 'spd_department_reference_date';\n\nconst currencyFields = new Set(['revenue', 'collected', 'outstanding', 'revenue_at_risk', 'monthly_target', 'opportunities_value', 'avg_deal_value', 'avg_won_deal_value']);\nconst percentFields = new Set(['target_pct', 'collection_efficiency_month', 'collection_efficiency_3m']);\nconst dayFields = new Set(['avg_time_to_close_deal', 'avg_time_lead_to_deal']);\n\nfunction fmt(key, value) {\n  const v = value || 0;\n  if (currencyFields.has(key)) return format_currency(v);\n  if (percentFields.has(key)) return `${flt(v, 3).toFixed(3)}%`;\n  if (dayFields.has(key)) return `${cint(v)} days`;\n  if (key === 'cash_conversion_flag') return value || 'Weak';\n  return `${cint(v)}`;\n}\n\nfunction render(data) {\n  root_element.querySelectorAll('[data-key]').forEach((el) => {\n    const key = el.getAttribute('data-key');\n    el.textContent = fmt(key, data[key]);\n\n    if (key === 'cash_conversion_flag') {\n      el.classList.remove('dp-flag-weak', 'dp-flag-watch', 'dp-flag-healthy');\n      const flag = (data[key] || 'Weak').toLowerCase();\n      if (flag === 'healthy') el.classList.add('dp-flag-healthy');\n      else if (flag === 'watch') el.classList.add('dp-flag-watch');\n      else el.classList.add('dp-flag-weak');\n    }\n  });\n}\n\nfunction loadKpis() {\n  const department = localStorage.getItem(storageKey) || '';\n  const risk_window_days = cint(localStorage.getItem(riskStorageKey) || 14);\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n  frappe.call({ method: kpiMethod, args: { department, risk_window_days, reference_date } }).then((r) => render(r.message || {}));\n}\n\nwindow.addEventListener('spd-department-changed', loadKpis);\nloadKpis();",
 "style": ".dp-kpi-wrap { display: flex; flex-direction: column; gap: 12px; }\n.dp-kpi-header h3, .dp-subhead { margin: 0; font-size: 18px; font-weight: 700; }\n.dp-subhead { margin-top: 6px; }\n.dp-kpi-grid { display: grid; gap: 10px; }\n.dp-kpi-grid-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }\n.dp-kpi-grid-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }\n.dp-kpi-grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }\n.dp-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 14px; min-height: 84px; background: var(--card-bg, var(--fg-color)); }\n.dp-label { font-size: 11px; color: var(--text-muted); font-weight: 600; letter-spacing: .3px; margin-bottom: 7px; }\n.dp-value { font-size: 20px; font-weight: 700; line-height: 1.1; }\n.dp-status { text-transform: uppercase; letter-spacing: .5px; font-size: 18px; }\n.dp-flag-weak { color: #b91c1c; }\n.dp-flag-watch { color: #d97706; }\n.dp-flag-healthy { color: #15803d; }\n.dp-green { color: #15803d; }\n.dp-blue { color: #1d4ed8; }\n.dp-orange { color: #d97706; }\n.dp-purple { color: #7e22ce; }\n@media (max-width: 1400px) { .dp-kpi-grid-5 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }\n@media (max-width: 1200px) { .dp-kpi-grid-4, .dp-kpi-grid-3, .dp-kpi-grid-5 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }\n@media (max-width: 768px) { .dp-kpi-grid-4, .dp-kpi-grid-3, .dp-kpi-grid-5 { grid-template-columns: 1fr; } }"
}
