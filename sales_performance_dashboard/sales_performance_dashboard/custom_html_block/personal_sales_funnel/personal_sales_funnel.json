{
 "doctype": "Custom HTML Block",
 "name": "Personal Sales Funnel",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"psd-funnel-card\"><div class=\"psd-funnel-header\">Personal Sales Funnel</div><div class=\"psd-funnel-sub\">Lead \u2192 Opportunity \u2192 Quotation \u2192 Customer \u2192 Sales Order \u2192 Delivery Note \u2192 Sales Invoice</div><div class=\"psd-funnel-body\"><svg class=\"psd-funnel-svg\" viewBox=\"0 0 520 520\" preserveAspectRatio=\"xMidYMin meet\"></svg><div class=\"psd-funnel-legend\"></div></div></div>",
 "script": "const method = \"sales_performance_dashboard.sales_performance_dashboard.dashboard_chart_source.personal_sales_funnel.personal_sales_funnel.get_data_for_custom\";\nconst colors = [\"#2dd4bf\", \"#f43f5e\", \"#f59e0b\", \"#84cc16\", \"#22c55e\", \"#0ea5e9\", \"#6366f1\"];\nconst svg = root_element.querySelector('.psd-funnel-svg');\nconst legend = root_element.querySelector('.psd-funnel-legend');\n\nfunction asInt(v) {\n\treturn cint(v || 0);\n}\n\nfunction blend(hex, pct) {\n\tconst c = (hex || '#000000').replace('#', '');\n\tconst n = parseInt(c, 16);\n\tlet r = (n >> 16) & 255;\n\tlet g = (n >> 8) & 255;\n\tlet b = n & 255;\n\tconst t = pct < 0 ? 0 : 255;\n\tconst p = Math.abs(pct);\n\tr = Math.round((t - r) * p + r);\n\tg = Math.round((t - g) * p + g);\n\tb = Math.round((t - b) * p + b);\n\treturn `rgb(${r}, ${g}, ${b})`;\n}\n\nfunction renderFunnel(labels, values) {\n\tconst safeVals = (values || []).map(asInt);\n\tconst max = Math.max(...safeVals, 1);\n\tconst minW = 90;\n\tconst maxW = 330;\n\tconst h = 40;\n\tconst gap = 1;\n\tconst totalH = (labels.length * (h + gap)) + gap + 2;\n\tsvg.setAttribute('viewBox', `0 0 420 ${totalH}`);\n\tsvg.innerHTML = '';\n\tlegend.innerHTML = '';\n\n\tconst defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\n\tconst shadow = document.createElementNS('http://www.w3.org/2000/svg', 'filter');\n\tshadow.setAttribute('id', 'psdFunnelShadow');\n\tshadow.setAttribute('x', '-20%');\n\tshadow.setAttribute('y', '-20%');\n\tshadow.setAttribute('width', '140%');\n\tshadow.setAttribute('height', '160%');\n\tconst feDrop = document.createElementNS('http://www.w3.org/2000/svg', 'feDropShadow');\n\tfeDrop.setAttribute('dx', '0');\n\tfeDrop.setAttribute('dy', '3');\n\tfeDrop.setAttribute('stdDeviation', '2.2');\n\tfeDrop.setAttribute('flood-color', '#0f172a');\n\tfeDrop.setAttribute('flood-opacity', '0.25');\n\tshadow.appendChild(feDrop);\n\tdefs.appendChild(shadow);\n\n\tcolors.forEach((base, i) => {\n\t\tconst grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');\n\t\tgrad.setAttribute('id', `psdGrad${i}`);\n\t\tgrad.setAttribute('x1', '0%');\n\t\tgrad.setAttribute('y1', '0%');\n\t\tgrad.setAttribute('x2', '0%');\n\t\tgrad.setAttribute('y2', '100%');\n\n\t\tconst s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n\t\ts1.setAttribute('offset', '0%');\n\t\ts1.setAttribute('stop-color', blend(base, 0.28));\n\t\tconst s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n\t\ts2.setAttribute('offset', '55%');\n\t\ts2.setAttribute('stop-color', base);\n\t\tconst s3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n\t\ts3.setAttribute('offset', '100%');\n\t\ts3.setAttribute('stop-color', blend(base, -0.18));\n\n\t\tgrad.appendChild(s1);\n\t\tgrad.appendChild(s2);\n\t\tgrad.appendChild(s3);\n\t\tdefs.appendChild(grad);\n\t});\n\tsvg.appendChild(defs);\n\n\tlet y = gap;\n\tfor (let i = 0; i < labels.length; i++) {\n\t\tconst current = safeVals[i];\n\t\tconst next = safeVals[i + 1] ?? safeVals[i];\n\t\tconst width = minW + (current / max) * (maxW - minW);\n\t\tconst nextWidth = minW + (next / max) * (maxW - minW);\n\t\tconst x = (420 - width) / 2;\n\t\tconst nx = (420 - nextWidth) / 2;\n\n\t\tconst topY = y + 4;\n\t\tconst bottomY = y + h - 4;\n\t\tconst d = `M ${x} ${topY} Q ${x + width / 2} ${y} ${x + width} ${topY} L ${nx + nextWidth} ${bottomY} Q ${nx + nextWidth / 2} ${y + h} ${nx} ${bottomY} Z`;\n\n\t\tconst seg = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n\t\tseg.setAttribute('d', d);\n\t\tseg.setAttribute('fill', `url(#psdGrad${i % colors.length})`);\n\t\tseg.setAttribute('filter', 'url(#psdFunnelShadow)');\n\n\t\tconst title = document.createElementNS('http://www.w3.org/2000/svg', 'title');\n\t\ttitle.textContent = `${labels[i]}: ${current}`;\n\t\tseg.appendChild(title);\n\t\tsvg.appendChild(seg);\n\n\t\tconst cap = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');\n\t\tcap.setAttribute('cx', String(x + width / 2));\n\t\tcap.setAttribute('cy', String(topY));\n\t\tcap.setAttribute('rx', String(Math.max(8, width / 2 - 6)));\n\t\tcap.setAttribute('ry', '4.5');\n\t\tcap.setAttribute('fill', 'rgba(255,255,255,0.22)');\n\t\tsvg.appendChild(cap);\n\n\t\tconst item = document.createElement('div');\n\t\titem.className = 'psd-funnel-legend-item';\n\t\titem.innerHTML = `<span class=\\\"psd-funnel-dot\\\" style=\\\"background:${colors[i % colors.length]}\\\"></span><span class=\\\"psd-funnel-label\\\">${frappe.utils.escape_html(labels[i])}</span><span class=\\\"psd-funnel-value\\\">${current}</span>`;\n\t\tlegend.appendChild(item);\n\n\t\ty += h + gap;\n\t}\n}\n\nfunction args() {\n\treturn {\n\t\tdepartment: localStorage.getItem('spd_personal_dashboard_department') || '',\n\t\temployee: localStorage.getItem('spd_personal_dashboard_employee') || '',\n\t};\n}\n\nfunction load() {\n\tfrappe.call({ method, args: args() }).then((r) => {\n\t\tconst data = r.message || {};\n\t\tconst labels = data.labels || [];\n\t\tconst values = (data.datasets && data.datasets[0] && data.datasets[0].values) || [];\n\t\trenderFunnel(labels, values);\n\t});\n}\n\nwindow.addEventListener('spd-personal-changed', load);\nload();\n",
 "style": ".psd-funnel-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px 14px 10px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.psd-funnel-header{font-size:16px;font-weight:700;margin-bottom:2px}.psd-funnel-sub{color:var(--text-muted);font-size:11px;margin-bottom:8px}.psd-funnel-body{display:grid;grid-template-columns:1fr;gap:10px}.psd-funnel-svg{width:100%;max-width:520px;height:auto;margin:0 auto;display:block}.psd-funnel-legend{display:grid;grid-template-columns:1fr 1fr;gap:6px}.psd-funnel-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-color)}.psd-funnel-dot{width:8px;height:8px;border-radius:999px;display:inline-block}.psd-funnel-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.psd-funnel-value{font-weight:600} @media (max-width: 768px){.psd-funnel-legend{grid-template-columns:1fr}} "
}
