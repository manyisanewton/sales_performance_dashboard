{
 "doctype": "Custom HTML Block",
 "name": "Department Discount Leakage",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"ddl-wrap\"><div class=\"ddl-head\"><h3>Discount Leakage</h3><p>Amount and percentage lost to discounting vs list price for the selected department.</p></div><div class=\"ddl-kpis\"><div class=\"ddl-card\"><div class=\"ddl-label\">LEAKAGE AMOUNT</div><div class=\"ddl-value ddl-red\" data-kpi=\"leakage_amount\"></div></div><div class=\"ddl-card\"><div class=\"ddl-label\">LEAKAGE %</div><div class=\"ddl-value ddl-orange\" data-kpi=\"leakage_pct\"></div></div><div class=\"ddl-card\"><div class=\"ddl-label\">NET REALIZATION %</div><div class=\"ddl-value ddl-green\" data-kpi=\"net_realization_pct\"></div></div><div class=\"ddl-card\"><div class=\"ddl-label\">AVG DISCOUNT %</div><div class=\"ddl-value ddl-purple\" data-kpi=\"avg_discount_pct\"></div></div></div><div class=\"ddl-grid\"><div class=\"ddl-panel\"><div class=\"ddl-title\">Leakage Trend</div><div class=\"ddl-sub\">By month within current filter period</div><div class=\"ddl-chart ddl-trend\"></div></div><div class=\"ddl-panel\"><div class=\"ddl-title\">Top Reps by Leakage</div><div class=\"ddl-sub\">Highest discount leakage contributors</div><div class=\"ddl-chart ddl-reps\"></div></div><div class=\"ddl-panel\"><div class=\"ddl-title\">Top Customers by Leakage</div><div class=\"ddl-sub\">Top 5 customer share of leakage</div><div class=\"ddl-chart ddl-customers\"></div></div><div class=\"ddl-panel\"><div class=\"ddl-title\">Leakage by Item Group</div><div class=\"ddl-sub\">Which product groups leak the most margin</div><div class=\"ddl-chart ddl-item-groups\"></div></div></div><div class=\"ddl-table-wrap\"><div class=\"ddl-title\">Highest Leakage Invoices</div><div class=\"ddl-sub\">Top invoices with highest price leakage</div><table class=\"ddl-table\"><thead><tr><th>#</th><th>Date</th><th>Invoice</th><th>Customer</th><th>Rep</th><th class=\"right\">List Value</th><th class=\"right\">Billed</th><th class=\"right\">Leakage</th><th class=\"right\">Leakage %</th></tr></thead><tbody class=\"ddl-table-body\"></tbody></table><div class=\"ddl-table-actions\"><button type=\"button\" class=\"btn btn-sm btn-secondary ddl-show-more\" style=\"display:none\">Show more</button></div></div></div>",
 "script": "const method = \"sales_performance_dashboard.api.department_dashboard_api.get_department_discount_leakage_dashboard\";\nconst storageDepartment = 'spd_department_dashboard_department';\nconst storageView = 'spd_department_view_mode';\nconst storageDate = 'spd_department_reference_date';\nconst TOP_CUSTOMERS_LIMIT = 5;\nconst TABLE_PAGE_SIZE = 5;\n\nconst trendRoot = root_element.querySelector('.ddl-trend');\nconst repsRoot = root_element.querySelector('.ddl-reps');\nconst customersRoot = root_element.querySelector('.ddl-customers');\nconst itemGroupsRoot = root_element.querySelector('.ddl-item-groups');\nconst tableBody = root_element.querySelector('.ddl-table-body');\nconst showMoreBtn = root_element.querySelector('.ddl-show-more');\n\nlet trendChart = null;\nlet repsChart = null;\nlet customersChart = null;\nlet itemGroupsChart = null;\nlet tableRows = [];\nlet visibleRows = 0;\n\nfunction asCurrency(value) {\n  return format_currency(flt(value || 0));\n}\n\nfunction asPercent(value) {\n  return `${flt(value || 0, 2).toFixed(2)}%`;\n}\n\nfunction compactLabel(value, maxLen = 16) {\n  const txt = String(value || 'Unknown').trim();\n  if (txt.length <= maxLen) return txt;\n  return `${txt.slice(0, maxLen - 1)}â€¦`;\n}\n\nfunction setKpis(kpis) {\n  const map = {\n    leakage_amount: asCurrency(kpis.leakage_amount),\n    leakage_pct: asPercent(kpis.leakage_pct),\n    net_realization_pct: asPercent(kpis.net_realization_pct),\n    avg_discount_pct: asPercent(kpis.avg_discount_pct),\n  };\n\n  root_element.querySelectorAll('[data-kpi]').forEach((el) => {\n    const key = el.getAttribute('data-kpi');\n    el.textContent = map[key] || '-';\n  });\n}\n\nfunction renderTrend(trend) {\n  const data = {\n    labels: trend.labels || [],\n    datasets: [\n      { name: 'Leakage Amount', values: trend.amount || [] },\n      { name: 'Leakage %', values: trend.pct || [] },\n    ],\n  };\n\n  if (!trendChart) {\n    trendChart = new frappe.Chart(trendRoot, {\n      data,\n      type: 'line',\n      height: 250,\n      colors: ['#dc2626', '#f59e0b'],\n      axisOptions: { xIsSeries: 1, xAxisMode: 'tick' },\n      lineOptions: { regionFill: 0 },\n      tooltipOptions: {\n        formatTooltipY: (value, y, i) => i === 0 ? asCurrency(value) : asPercent(value),\n      },\n    });\n    return;\n  }\n  trendChart.update(data);\n}\n\nfunction renderTopReps(rows) {\n  const data = {\n    labels: (rows || []).map((d) => d.name),\n    datasets: [{ name: 'Leakage Amount', values: (rows || []).map((d) => flt(d.leakage || 0)) }],\n  };\n\n  if (!repsChart) {\n    repsChart = new frappe.Chart(repsRoot, {\n      data,\n      type: 'bar',\n      height: 260,\n      colors: ['#ef4444'],\n      axisOptions: { xAxisMode: 'tick', xIsSeries: 1 },\n      tooltipOptions: { formatTooltipY: (value) => asCurrency(value) },\n    });\n    return;\n  }\n  repsChart.update(data);\n}\n\nfunction renderTopCustomers(rows) {\n  const safeRows = (rows || []).slice(0, TOP_CUSTOMERS_LIMIT);\n  if (!safeRows.length) {\n    customersRoot.innerHTML = '<div class=\\\"ddl-empty\\\">No customer leakage data in this period</div>';\n    customersChart = null;\n    return;\n  }\n\n  const data = {\n    labels: safeRows.map((d) => compactLabel(d.name, 16)),\n    datasets: [{ name: 'Leakage Amount', values: safeRows.map((d) => flt(d.leakage || 0)) }],\n  };\n\n  if (!customersChart) {\n    customersRoot.innerHTML = '';\n    customersChart = new frappe.Chart(customersRoot, {\n      data,\n      type: 'bar',\n      height: 260,\n      colors: ['#8b5cf6'],\n      axisOptions: { xAxisMode: 'tick', xIsSeries: 1 },\n      tooltipOptions: { formatTooltipY: (value) => asCurrency(value) },\n    });\n    return;\n  }\n  customersChart.update(data);\n}\n\nfunction renderItemGroups(rows) {\n  const data = {\n    labels: (rows || []).map((d) => d.name),\n    datasets: [{ name: 'Leakage Amount', values: (rows || []).map((d) => flt(d.leakage || 0)) }],\n  };\n\n  if (!itemGroupsChart) {\n    itemGroupsChart = new frappe.Chart(itemGroupsRoot, {\n      data,\n      type: 'bar',\n      height: 260,\n      colors: ['#7c3aed'],\n      axisOptions: { xAxisMode: 'tick', xIsSeries: 1 },\n      tooltipOptions: { formatTooltipY: (value) => asCurrency(value) },\n    });\n    return;\n  }\n  itemGroupsChart.update(data);\n}\n\nfunction syncShowMore() {\n  const hasMore = visibleRows < tableRows.length;\n  showMoreBtn.style.display = hasMore ? 'inline-flex' : 'none';\n}\n\nfunction rowHtml(d) {\n  return `\n    <tr class=\\\"ddl-table-row\\\" data-invoice=\\\"${frappe.utils.escape_html(d.invoice || '')}\\\" title=\\\"Open invoice details\\\">\n      <td>${d.idx}</td>\n      <td>${frappe.datetime.str_to_user(d.date)}</td>\n      <td>${frappe.utils.escape_html(d.invoice || '')}</td>\n      <td>${frappe.utils.escape_html(d.customer || '')}</td>\n      <td>${frappe.utils.escape_html(d.rep || '')}</td>\n      <td class=\\\"right\\\">${asCurrency(d.list_value)}</td>\n      <td class=\\\"right\\\">${asCurrency(d.billed_value)}</td>\n      <td class=\\\"right ddl-red-t\\\">${asCurrency(d.leakage)}</td>\n      <td class=\\\"right\\\">${asPercent(d.leakage_pct)}</td>\n    </tr>\n  `;\n}\n\nfunction renderTable() {\n  const rows = tableRows.slice(0, visibleRows);\n  const html = rows.map((d) => rowHtml(d)).join('');\n  tableBody.innerHTML = html || '<tr><td colspan=\\\"9\\\" class=\\\"ddl-empty\\\">No discount leakage data in this period</td></tr>';\n  syncShowMore();\n}\n\nfunction openInvoice(invoice) {\n  if (!invoice) return;\n  frappe.set_route('Form', 'Sales Invoice', invoice);\n}\n\nfunction load() {\n  const department = localStorage.getItem(storageDepartment) || '';\n  const view_mode = localStorage.getItem(storageView) || 'Monthly';\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n\n  frappe.call({\n    method,\n    args: {\n      department,\n      view_mode,\n      reference_date,\n      limit: 8,\n      table_limit: 100,\n    },\n  }).then((r) => {\n    const payload = r.message || {};\n    setKpis(payload.kpis || {});\n    renderTrend(payload.trend || {});\n    renderTopReps(payload.top_reps || []);\n    renderTopCustomers(payload.top_customers || []);\n    renderItemGroups(payload.item_groups || []);\n\n    tableRows = payload.table || [];\n    visibleRows = Math.min(TABLE_PAGE_SIZE, tableRows.length);\n    renderTable();\n  });\n}\n\nshowMoreBtn.addEventListener('click', () => {\n  visibleRows = Math.min(visibleRows + TABLE_PAGE_SIZE, tableRows.length);\n  renderTable();\n});\n\ntableBody.addEventListener('click', (e) => {\n  const row = e.target.closest('tr.ddl-table-row[data-invoice]');\n  if (!row) return;\n  openInvoice(row.getAttribute('data-invoice'));\n});\n\nwindow.addEventListener('spd-department-changed', load);\nload();",
 "style": ".ddl-wrap{display:flex;flex-direction:column;gap:12px;background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.ddl-head h3{margin:0;font-size:18px;font-weight:700}.ddl-head p{margin:2px 0 0 0;font-size:12px;color:var(--text-muted)}.ddl-kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}.ddl-card{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}.ddl-label{font-size:11px;color:#52525b;font-weight:600;letter-spacing:.3px;margin-bottom:6px}.ddl-value{font-size:24px;font-weight:700;line-height:1.1}.ddl-green{color:#15803d}.ddl-orange{color:#d97706}.ddl-purple{color:#7e22ce}.ddl-red{color:#b91c1c}.ddl-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}.ddl-panel{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}.ddl-title{font-size:14px;font-weight:700}.ddl-sub{font-size:11px;color:var(--text-muted);margin-bottom:8px}.ddl-chart{min-height:250px}.ddl-table-wrap{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px 12px}.ddl-table{width:100%;border-collapse:collapse;font-size:12px}.ddl-table th,.ddl-table td{padding:8px 7px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top}.ddl-table th{font-size:11px;color:#475569;font-weight:700}.ddl-table .right{text-align:right}.ddl-red-t{color:#b91c1c;font-weight:600}.ddl-empty{text-align:center;color:#64748b;padding:14px 0}.ddl-table-actions{display:flex;justify-content:flex-end;padding-top:10px}.ddl-show-more{min-width:96px;justify-content:center}.ddl-table-row{cursor:pointer}.ddl-table-row:hover td{background:#f8fafc}@media (max-width:1200px){.ddl-kpis{grid-template-columns:repeat(2,minmax(0,1fr))}.ddl-grid{grid-template-columns:1fr}}@media (max-width:768px){.ddl-kpis{grid-template-columns:1fr}.ddl-value{font-size:20px}}"
}
