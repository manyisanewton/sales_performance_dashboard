{
 "doctype": "Custom HTML Block",
 "name": "Department Gross Margin Trend",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"dsd-gm-card\"><div class=\"dsd-gm-header\">Gross Margin % Trend</div><div class=\"dsd-gm-sub\">Monthly margin trend (Sales - COGS) to highlight profitable vs unprofitable periods</div><div class=\"dsd-gm-chart\"></div></div>",
 "script": "const method = \"sales_performance_dashboard.api.department_dashboard_api.get_department_gross_margin_trend\";\nconst storageDepartment = 'spd_department_dashboard_department';\nconst storageDate = 'spd_department_reference_date';\nconst chartRoot = root_element.querySelector('.dsd-gm-chart');\nconst sub = root_element.querySelector('.dsd-gm-sub');\nlet chart = null;\n\nfunction load() {\n  const department = localStorage.getItem(storageDepartment) || '';\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n\n  frappe.call({ method, args: { department, reference_date, months: 12 } })\n    .then((r) => {\n      const payload = r.message || { labels: [], datasets: [{ name: 'Gross Margin %', values: [] }] };\n      const data = {\n        labels: payload.labels || [],\n        datasets: payload.datasets || [{ name: 'Gross Margin %', values: [] }],\n      };\n      sub.textContent = 'Monthly margin trend (Sales - COGS) to highlight profitable vs unprofitable periods';\n\n      if (!chart) {\n        chart = new frappe.Chart(chartRoot, {\n          data,\n          type: 'line',\n          height: 280,\n          colors: ['#16a34a'],\n          lineOptions: { regionFill: 0 },\n          axisOptions: { xIsSeries: 1, xAxisMode: 'tick' },\n          tooltipOptions: {\n            formatTooltipY: (value) => `${flt(value, 2).toFixed(2)}%`,\n          },\n        });\n        return;\n      }\n      chart.update(data);\n    })\n    .catch(() => {\n      sub.textContent = 'Could not load gross margin trend data';\n    });\n}\n\nwindow.addEventListener('spd-department-changed', load);\nload();",
 "style": ".dsd-gm-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px 14px 10px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dsd-gm-header{font-size:16px;font-weight:700;margin-bottom:2px}.dsd-gm-sub{color:var(--text-muted);font-size:11px;margin-bottom:8px}.dsd-gm-chart{min-height:280px}"
}
