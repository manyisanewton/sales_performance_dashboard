{
 "creation": "2026-02-12 14:05:00.000000",
 "docstatus": 0,
 "doctype": "Custom HTML Block",
 "html": "<div class=\"dkr-wrap\"><h3>Revenue &amp; Targets</h3><div class=\"dkr-grid dkr-grid-5\"><div class=\"dkr-card\"><div class=\"dkr-label\">TOTAL REVENUE</div><div class=\"dkr-val dkr-green\" data-key=\"revenue\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">TOTAL COLLECTED</div><div class=\"dkr-val dkr-blue\" data-key=\"collected\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">TOTAL OUTSTANDING</div><div class=\"dkr-val dkr-orange\" data-key=\"outstanding\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">REVENUE AT RISK</div><div class=\"dkr-val dkr-red\" data-key=\"revenue_at_risk\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">MONTHLY TARGET</div><div class=\"dkr-val dkr-purple\" data-key=\"monthly_target\"></div></div></div><div class=\"dkr-grid dkr-grid-3\"><div class=\"dkr-card\"><div class=\"dkr-label\">% TOWARDS TARGET</div><div class=\"dkr-val dkr-green\" data-key=\"target_pct\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">TOTAL INVOICES</div><div class=\"dkr-val dkr-purple\" data-key=\"total_invoices\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">OPPORTUNITIES VALUE</div><div class=\"dkr-val dkr-purple\" data-key=\"opportunities_value\"></div></div></div><div class=\"dkr-grid dkr-grid-3\"><div class=\"dkr-card\"><div class=\"dkr-label\">COLLECTION EFFICIENCY (MONTH)</div><div class=\"dkr-val dkr-green\" data-key=\"collection_efficiency_month\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">COLLECTION EFFICIENCY (ROLLING 3M)</div><div class=\"dkr-val dkr-blue\" data-key=\"collection_efficiency_3m\"></div></div><div class=\"dkr-card\"><div class=\"dkr-label\">CASH CONVERSION FLAG</div><div class=\"dkr-val dkr-status\" data-key=\"cash_conversion_flag\"></div></div></div></div>",
 "idx": 0,
 "modified": "2026-02-12 14:05:00.000000",
 "modified_by": "Administrator",
 "module": "Sales Performance Dashboard",
 "name": "Department KPI Revenue Customers",
 "owner": "Administrator",
 "private": 0,
 "script": "const kpiMethod = \"sales_performance_dashboard.api.department_dashboard_api.get_department_kpis\";\nconst ownerUsersMethod = \"sales_performance_dashboard.api.department_dashboard_api.get_department_owner_users\";\nconst storageKey = 'spd_department_dashboard_department';\nconst storageDate = 'spd_department_reference_date';\nconst storageView = 'spd_department_view_mode';\nconst riskStorageKey = 'spd_department_risk_window';\n\nconst currencyFields = new Set(['revenue', 'collected', 'outstanding', 'revenue_at_risk', 'monthly_target', 'opportunities_value']);\nconst percentFields = new Set(['target_pct', 'collection_efficiency_month', 'collection_efficiency_3m']);\nlet ownerUsersCache = { department: '', users: [] };\n\nfunction fmt(key, value) {\n  const v = value || 0;\n  if (currencyFields.has(key)) return format_currency(v);\n  if (percentFields.has(key)) return `${flt(v, 3).toFixed(3)}%`;\n  if (key === 'cash_conversion_flag') return value || 'Weak';\n  return `${cint(v)}`;\n}\n\nfunction render(data) {\n  root_element.querySelectorAll('[data-key]').forEach((el) => {\n    const key = el.getAttribute('data-key');\n    el.textContent = fmt(key, data[key]);\n\n    if (key === 'cash_conversion_flag') {\n      el.classList.remove('dkr-flag-weak', 'dkr-flag-watch', 'dkr-flag-healthy');\n      const flag = (data[key] || 'Weak').toLowerCase();\n      if (flag === 'healthy') el.classList.add('dkr-flag-healthy');\n      else if (flag === 'watch') el.classList.add('dkr-flag-watch');\n      else el.classList.add('dkr-flag-weak');\n    }\n  });\n}\n\nfunction getFilters() {\n  return {\n    department: localStorage.getItem(storageKey) || '',\n    reference_date: localStorage.getItem(storageDate) || frappe.datetime.get_today(),\n    view_mode: localStorage.getItem(storageView) || 'Monthly',\n    risk_window_days: cint(localStorage.getItem(riskStorageKey) || 14),\n  };\n}\n\nasync function getOwnerUsers(department) {\n  if (!department) return [];\n  if (ownerUsersCache.department === department && ownerUsersCache.users.length) {\n    return ownerUsersCache.users;\n  }\n  const r = await frappe.call({ method: ownerUsersMethod, args: { department } });\n  const users = Array.isArray(r.message) ? r.message : [];\n  ownerUsersCache = { department, users };\n  return users;\n}\n\nfunction openList(doctype, filters) {\n  frappe.route_options = filters || {};\n  frappe.set_route('List', doctype);\n}\n\nasync function openByKey(key) {\n  const f = getFilters();\n  const department = f.department;\n  if (!department) {\n    frappe.show_alert({ message: 'Select a department first.', indicator: 'orange' });\n    return;\n  }\n\n  const ownerUsers = await getOwnerUsers(department);\n  const ownerFilter = ownerUsers.length ? ['in', ownerUsers] : null;\n\n  if (['monthly_target', 'target_pct'].includes(key)) {\n    frappe.route_options = { target_level: 'Department', department };\n    frappe.set_route('List', 'Sales Targets');\n    return;\n  }\n\n  if (key === 'opportunities_value') {\n    const filters = ownerFilter ? { owner: ownerFilter } : {};\n    openList('Opportunity', filters);\n    return;\n  }\n\n  if (key === 'total_invoices' || key === 'revenue') {\n    const filters = { docstatus: 1 };\n    if (ownerFilter) filters.owner = ownerFilter;\n    openList('Sales Invoice', filters);\n    return;\n  }\n\n  if (key === 'collected') {\n    const filters = { docstatus: 1, payment_type: 'Receive', party_type: 'Customer' };\n    if (ownerFilter) filters.owner = ownerFilter;\n    openList('Payment Entry', filters);\n    return;\n  }\n\n  if (key === 'outstanding' || key === 'collection_efficiency_month' || key === 'collection_efficiency_3m' || key === 'cash_conversion_flag') {\n    const filters = { docstatus: 1, outstanding_amount: ['>', 0] };\n    if (ownerFilter) filters.owner = ownerFilter;\n    openList('Sales Invoice', filters);\n    return;\n  }\n\n  if (key === 'revenue_at_risk') {\n    const dueBy = frappe.datetime.add_days(frappe.datetime.get_today(), cint(f.risk_window_days || 14));\n    const filters = { docstatus: 1, outstanding_amount: ['>', 0], due_date: ['<=', dueBy] };\n    if (ownerFilter) filters.owner = ownerFilter;\n    openList('Sales Invoice', filters);\n    return;\n  }\n\n  const fallback = { department, period: f.view_mode, period_date: f.reference_date };\n  frappe.route_options = fallback;\n  frappe.set_route('query-report', 'Sales Performance Snapshot');\n}\n\nfunction bindCardClicks() {\n  root_element.querySelectorAll('.dkr-card').forEach((card) => {\n    card.classList.add('dkr-clickable');\n    card.title = 'Open source records';\n  });\n\n  if (root_element.__dkr_click_bound) return;\n  root_element.__dkr_click_bound = true;\n\n  root_element.addEventListener('click', (ev) => {\n    const card = ev.target && ev.target.closest ? ev.target.closest('.dkr-card') : null;\n    if (!card || !root_element.contains(card)) return;\n    const keyEl = card.querySelector('[data-key]');\n    if (!keyEl) return;\n    const key = keyEl.getAttribute('data-key');\n    if (!key) return;\n    openByKey(key);\n  }, true);\n}\n\nfunction loadKpis() {\n  const { department, risk_window_days, reference_date } = getFilters();\n  frappe.call({ method: kpiMethod, args: { department, risk_window_days, reference_date } }).then((r) => render(r.message || {}));\n}\n\nbindCardClicks();\nwindow.addEventListener('spd-department-changed', loadKpis);\nloadKpis();",
 "style": ".dkr-wrap{display:flex;flex-direction:column;gap:10px}.dkr-wrap h3,.dkr-sub{margin:0;font-size:24px;font-weight:700}.dkr-sub{font-size:20px;margin-top:4px}.dkr-grid{display:grid;gap:10px}.dkr-grid-5{grid-template-columns:repeat(5,minmax(0,1fr))}.dkr-grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}.dkr-grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}.dkr-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;min-height:82px;background:#fff}.dkr-card.dkr-clickable{cursor:pointer;transition:all .12s ease}.dkr-card.dkr-clickable:hover{border-color:#cbd5e1;box-shadow:0 4px 14px rgba(15,23,42,.08);transform:translateY(-1px)}.dkr-label{font-size:11px;color:#52525b;font-weight:600;letter-spacing:.3px;margin-bottom:7px}.dkr-val{font-size:20px;font-weight:700;line-height:1.1}.dkr-status{text-transform:uppercase;letter-spacing:.5px;font-size:18px}.dkr-flag-weak{color:#b91c1c}.dkr-flag-watch{color:#d97706}.dkr-flag-healthy{color:#15803d}.dkr-green{color:#15803d}.dkr-blue{color:#1d4ed8}.dkr-orange{color:#d97706}.dkr-purple{color:#7e22ce}.dkr-red{color:#b91c1c}@media (max-width:1400px){.dkr-grid-5{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (max-width:1200px){.dkr-grid-4,.dkr-grid-3,.dkr-grid-5{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:768px){.dkr-grid-4,.dkr-grid-3,.dkr-grid-5{grid-template-columns:1fr}}"
}
