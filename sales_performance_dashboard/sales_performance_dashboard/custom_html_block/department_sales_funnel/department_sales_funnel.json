{
 "doctype": "Custom HTML Block",
 "name": "Department Sales Funnel",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"dsd-funnel-card\"><div class=\"dsd-funnel-header\">Department Sales Funnel</div><div class=\"dsd-funnel-sub\">Lead \u2192 Opportunity \u2192 Customer \u2192 Quotation \u2192 Sales Order</div><div class=\"dsd-funnel-body\"><svg class=\"dsd-funnel-svg\" viewBox=\"0 0 520 300\" preserveAspectRatio=\"xMidYMin meet\"></svg><div class=\"dsd-funnel-legend\"></div></div></div>",
 "script": "const method = \"sales_performance_dashboard.sales_performance_dashboard.dashboard_chart_source.department_sales_funnel.department_sales_funnel.get_data_for_custom\";\nconst colors = [\"#2dd4bf\", \"#f59e0b\", \"#22c55e\", \"#0ea5e9\", \"#6366f1\"];\nconst storageKey = 'spd_department_dashboard_department';\nconst svg = root_element.querySelector('.dsd-funnel-svg');\nconst legend = root_element.querySelector('.dsd-funnel-legend');\n\nfunction asInt(v) {\n\treturn cint(v || 0);\n}\n\nfunction blend(hex, pct) {\n\tconst c = (hex || '#000000').replace('#', '');\n\tconst n = parseInt(c, 16);\n\tlet r = (n >> 16) & 255;\n\tlet g = (n >> 8) & 255;\n\tlet b = n & 255;\n\tconst t = pct < 0 ? 0 : 255;\n\tconst p = Math.abs(pct);\n\tr = Math.round((t - r) * p + r);\n\tg = Math.round((t - g) * p + g);\n\tb = Math.round((t - b) * p + b);\n\treturn `rgb(${r}, ${g}, ${b})`;\n}\n\nfunction renderFunnel(labels, values) {\n\tconst safeVals = (values || []).map(asInt);\n\tconst max = Math.max(...safeVals, 1);\n\tconst minW = 90;\n\tconst maxW = 330;\n\tconst h = 42;\n\tconst gap = 5;\n\tconst totalH = (labels.length * (h + gap)) + gap + 2;\n\tsvg.setAttribute('viewBox', `0 0 420 ${totalH}`);\n\tsvg.innerHTML = '';\n\tlegend.innerHTML = '';\n\n\tconst defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\n\tconst shadow = document.createElementNS('http://www.w3.org/2000/svg', 'filter');\n\tshadow.setAttribute('id', 'dsdFunnelShadow');\n\tshadow.setAttribute('x', '-20%');\n\tshadow.setAttribute('y', '-20%');\n\tshadow.setAttribute('width', '140%');\n\tshadow.setAttribute('height', '160%');\n\tconst feDrop = document.createElementNS('http://www.w3.org/2000/svg', 'feDropShadow');\n\tfeDrop.setAttribute('dx', '0');\n\tfeDrop.setAttribute('dy', '3');\n\tfeDrop.setAttribute('stdDeviation', '2.2');\n\tfeDrop.setAttribute('flood-color', '#0f172a');\n\tfeDrop.setAttribute('flood-opacity', '0.25');\n\tshadow.appendChild(feDrop);\n\tdefs.appendChild(shadow);\n\n\tcolors.forEach((base, i) => {\n\t\tconst grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');\n\t\tgrad.setAttribute('id', `dsdGrad${i}`);\n\t\tgrad.setAttribute('x1', '0%');\n\t\tgrad.setAttribute('y1', '0%');\n\t\tgrad.setAttribute('x2', '0%');\n\t\tgrad.setAttribute('y2', '100%');\n\n\t\tconst s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n\t\ts1.setAttribute('offset', '0%');\n\t\ts1.setAttribute('stop-color', blend(base, 0.28));\n\t\tconst s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n\t\ts2.setAttribute('offset', '55%');\n\t\ts2.setAttribute('stop-color', base);\n\t\tconst s3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n\t\ts3.setAttribute('offset', '100%');\n\t\ts3.setAttribute('stop-color', blend(base, -0.18));\n\n\t\tgrad.appendChild(s1);\n\t\tgrad.appendChild(s2);\n\t\tgrad.appendChild(s3);\n\t\tdefs.appendChild(grad);\n\t});\n\tsvg.appendChild(defs);\n\n\tlet y = gap;\n\tfor (let i = 0; i < labels.length; i++) {\n\t\tconst current = safeVals[i];\n\t\tconst next = safeVals[i + 1] ?? safeVals[i];\n\t\tconst width = minW + (current / max) * (maxW - minW);\n\t\tconst nextWidth = minW + (next / max) * (maxW - minW);\n\t\tconst x = (420 - width) / 2;\n\t\tconst nx = (420 - nextWidth) / 2;\n\n\t\tconst topY = y + 8;\n\t\tconst bottomY = y + h - 8;\n\t\tconst d = `M ${x} ${topY} Q ${x + width / 2} ${y - 2} ${x + width} ${topY} L ${nx + nextWidth} ${bottomY} Q ${nx + nextWidth / 2} ${y + h + 4} ${nx} ${bottomY} Z`;\n\n\t\tconst seg = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n\t\tseg.setAttribute('d', d);\n\t\tseg.setAttribute('fill', `url(#dsdGrad${i % colors.length})`);\n\t\tseg.setAttribute('filter', 'url(#dsdFunnelShadow)');\n\n\t\tconst title = document.createElementNS('http://www.w3.org/2000/svg', 'title');\n\t\ttitle.textContent = `${labels[i]}: ${current}`;\n\t\tseg.appendChild(title);\n\t\tsvg.appendChild(seg);\n\n\t\tconst cap = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');\n\t\tcap.setAttribute('cx', String(x + width / 2));\n\t\tcap.setAttribute('cy', String(topY));\n\t\tcap.setAttribute('rx', String(Math.max(8, width / 2 - 6)));\n\t\tcap.setAttribute('ry', '5.5');\n\t\tcap.setAttribute('fill', 'rgba(255,255,255,0.22)');\n\t\tsvg.appendChild(cap);\n\n\t\tconst item = document.createElement('div');\n\t\titem.className = 'dsd-funnel-legend-item';\n\t\titem.innerHTML = `<span class=\\\"dsd-funnel-dot\\\" style=\\\"background:${colors[i % colors.length]}\\\"></span><span class=\\\"dsd-funnel-label\\\">${frappe.utils.escape_html(labels[i])}</span><span class=\\\"dsd-funnel-value\\\">${current}</span>`;\n\t\tlegend.appendChild(item);\n\n\t\ty += h + gap;\n\t}\n}\n\nfunction load() {\n\tconst department = localStorage.getItem(storageKey) || '';\n\tfrappe.call({ method, args: { department } }).then((r) => {\n\t\tconst data = r.message || {};\n\t\tconst labels = data.labels || [];\n\t\tconst values = (data.datasets && data.datasets[0] && data.datasets[0].values) || [];\n\t\trenderFunnel(labels, values);\n\t});\n}\n\nwindow.addEventListener('spd-department-changed', load);\nload();\n",
 "style": ".dsd-funnel-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px 14px 10px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dsd-funnel-header{font-size:16px;font-weight:700;margin-bottom:2px}.dsd-funnel-sub{color:var(--text-muted);font-size:11px;margin-bottom:8px}.dsd-funnel-body{display:grid;grid-template-columns:1fr;gap:10px}.dsd-funnel-svg{width:100%;max-width:520px;height:auto;margin:0 auto;display:block}.dsd-funnel-legend{display:grid;grid-template-columns:1fr 1fr;gap:6px}.dsd-funnel-legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-color)}.dsd-funnel-dot{width:8px;height:8px;border-radius:999px;display:inline-block}.dsd-funnel-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dsd-funnel-value{font-weight:600}@media (max-width: 768px){.dsd-funnel-legend{grid-template-columns:1fr}}"
}
