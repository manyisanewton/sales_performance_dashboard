{
 "doctype": "Custom HTML Block",
 "name": "Department Project Pipeline",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class='dpp-card'><div class='dpp-title'>Department Project Pipeline</div><div class='dpp-sub'>Project status mix for selected department</div><div class='dpp-body'><div class='dpp-left'><div class='dpp-chart'></div></div><div class='dpp-right'><div class='dpp-status-list'></div></div></div><div class='dpp-finance-cards'></div><div class='dpp-total'>Total Projects: <b class='dpp-total-value' title='Open department projects'>0</b></div></div>",
 "script": "var method = \"sales_performance_dashboard.api.department_dashboard_api.get_department_project_status_finance\";\nvar chartWrap = root_element.querySelector(\".dpp-chart\");\nvar totalEl = root_element.querySelector(\".dpp-total-value\");\nvar listWrap = root_element.querySelector(\".dpp-status-list\");\nvar financeWrap = root_element.querySelector(\".dpp-finance-cards\");\nvar payload = {};\n\nfunction args() {\n  return {\n    department: localStorage.getItem(\"spd_department_dashboard_department\") || \"\",\n    view_mode: localStorage.getItem(\"spd_department_view_mode\") || \"Monthly\",\n    reference_date: localStorage.getItem(\"spd_department_reference_date\") || frappe.datetime.get_today(),\n  };\n}\n\nfunction money(v) {\n  var num = Number(v || 0);\n  if (isNaN(num)) num = 0;\n  if (typeof format_currency === \"function\") return format_currency(num);\n  return \"Sh \" + num.toFixed(2);\n}\n\nfunction c(v) {\n  var num = Number(v || 0);\n  if (isNaN(num)) num = 0;\n  return Math.max(0, Math.round(num));\n}\n\nfunction openProjectList(filter) {\n  var routeOptions = {};\n  if (payload.owners && payload.owners.length) routeOptions.owner = [\"in\", payload.owners];\n  if (filter === \"ongoing\") routeOptions.status = [\"in\", [\"Open\", \"In Progress\", \"Working\"]];\n  if (filter === \"completed\") routeOptions.status = \"Completed\";\n  if (filter === \"cancelled\") routeOptions.status = \"Cancelled\";\n  frappe.route_options = routeOptions;\n  frappe.set_route(\"List\", \"Project\");\n}\n\nfunction openInvoiceList(names, extraFilters) {\n  if (!names || !names.length) {\n    frappe.show_alert({ message: \"No invoices in this scope.\", indicator: \"orange\" });\n    return;\n  }\n  var routeOptions = { name: [\"in\", names] };\n  if (extraFilters) {\n    for (var k in extraFilters) routeOptions[k] = extraFilters[k];\n  }\n  frappe.route_options = routeOptions;\n  frappe.set_route(\"List\", \"Sales Invoice\");\n}\n\nfunction onCardClick(key) {\n  var b = payload.bucket_invoice_names || {};\n  if (key === \"status_total\") return openProjectList(\"total\");\n  if (key === \"status_ongoing\") return openProjectList(\"ongoing\");\n  if (key === \"status_completed\") return openProjectList(\"completed\");\n  if (key === \"money_revenue\") return openInvoiceList(payload.invoice_names_period || []);\n  if (key === \"money_outstanding\") return openInvoiceList(payload.invoice_names_outstanding || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_0_30\") return openInvoiceList(b[\"0-30\"] || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_31_60\") return openInvoiceList(b[\"31-60\"] || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_61_90\") return openInvoiceList(b[\"61-90\"] || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_90p\") return openInvoiceList(b[\"90+\"] || [], { outstanding_amount: [\">\", 0] });\n}\n\nfunction bindRowClicks() {\n  var rows = listWrap.querySelectorAll(\".dpp-status-row\");\n  for (var i = 0; i < rows.length; i++) {\n    rows[i].addEventListener(\"click\", function () {\n      var s = this.getAttribute(\"data-status\");\n      if (s === \"Open\" || s === \"In Progress\") return openProjectList(\"ongoing\");\n      if (s === \"Completed\") return openProjectList(\"completed\");\n      if (s === \"Cancelled\") return openProjectList(\"cancelled\");\n    });\n  }\n}\n\nfunction bindCardClicks() {\n  var cards = financeWrap.querySelectorAll(\".dpp-fin-card\");\n  for (var i = 0; i < cards.length; i++) {\n    cards[i].addEventListener(\"click\", function () {\n      onCardClick(this.getAttribute(\"data-key\"));\n    });\n  }\n}\n\nfunction bindTotalClick() {\n  totalEl.onclick = function () { openProjectList(\"total\"); };\n}\n\nfunction esc(s) { return frappe.utils.escape_html(String(s || \"\")); }\n\nfunction finCardHtml(item) {\n  return \"<div class=\\\"dpp-fin-card\\\" data-key=\\\"\" + esc(item.key) + \"\\\" title=\\\"Click to open details\\\">\"\n    + \"<div class=\\\"dpp-fin-label\\\">\" + esc(item.label) + \"</div>\"\n    + \"<div class=\\\"dpp-fin-value \" + (item.cls === \"count\" ? \"dpp-fin-count\" : \"\") + \"\\\">\" + esc(item.value) + \"</div>\"\n    + \"</div>\";\n}\n\nfunction statusRowHtml(label, val, color) {\n  return \"<div class=\\\"dpp-status-row\\\" data-status=\\\"\" + esc(label) + \"\\\" title=\\\"Open \" + esc(label) + \" projects\\\">\"\n    + \"<span class=\\\"dpp-dot\\\" style=\\\"background:\" + esc(color) + \"\\\"></span>\"\n    + \"<span class=\\\"dpp-label\\\">\" + esc(label) + \"</span>\"\n    + \"<span class=\\\"dpp-val\\\">\" + esc(val) + \"</span>\"\n    + \"</div>\";\n}\n\nfunction renderCards(data) {\n  var cts = data.counts || {};\n  var m = data.money || {};\n  var a = data.aging || {};\n  var cards = [\n    { key: \"status_total\", label: \"Total Projects\", value: c(cts.total), cls: \"count\" },\n    { key: \"status_ongoing\", label: \"Ongoing Projects\", value: c(cts.ongoing), cls: \"count\" },\n    { key: \"status_completed\", label: \"Completed Projects\", value: c(cts.completed), cls: \"count\" },\n    { key: \"money_revenue\", label: \"Total Revenue\", value: money(m.total_revenue), cls: \"money\" },\n    { key: \"money_outstanding\", label: \"Outstanding\", value: money(m.outstanding), cls: \"money\" },\n    { key: \"aging_0_30\", label: \"Aging 0-30\", value: money(a[\"0-30\"]), cls: \"money\" },\n    { key: \"aging_31_60\", label: \"Aging 31-60\", value: money(a[\"31-60\"]), cls: \"money\" },\n    { key: \"aging_61_90\", label: \"Aging 61-90\", value: money(a[\"61-90\"]), cls: \"money\" },\n    { key: \"aging_90p\", label: \"Aging 90+\", value: money(a[\"90+\"]), cls: \"money\" },\n  ];\n\n  var html = \"\";\n  for (var i = 0; i < cards.length; i++) html += finCardHtml(cards[i]);\n  financeWrap.innerHTML = html;\n  bindCardClicks();\n}\n\nfunction renderChart(labels, values, colors) {\n  chartWrap.innerHTML = \"\";\n  var total = 0;\n  for (var i = 0; i < values.length; i++) total += Number(values[i] || 0);\n  if (total <= 0) {\n    chartWrap.innerHTML = \"<div class=\\\"dpp-empty-ring\\\">No project data</div>\";\n    return;\n  }\n  try {\n    new frappe.Chart(chartWrap, {\n      type: \"donut\",\n      height: 260,\n      showLegend: 0,\n      data: { labels: labels, datasets: [{ values: values }] },\n      colors: colors,\n      tooltipOptions: { formatTooltipY: function (v) { return c(v || 0) + \" project(s)\"; } },\n    });\n    var hide = chartWrap.querySelectorAll(\".graph-stats-container,.stats,.chart-legend\");\n    for (var j = 0; j < hide.length; j++) hide[j].style.display = \"none\";\n  } catch (e) {\n    console.error(\"Department Project Pipeline chart error\", e);\n    chartWrap.innerHTML = \"<div class=\\\"dpp-empty-ring\\\">Unable to render chart</div>\";\n  }\n}\n\nfunction render(data) {\n  var cts = data.counts || {};\n  var labels = [\"Open\", \"In Progress\", \"Completed\", \"Cancelled\"];\n  var openCount = Math.max(0, c(cts.total) - c(cts.ongoing) - c(cts.completed));\n  var values = [openCount, c(cts.ongoing), c(cts.completed), 0];\n  var colors = [\"#3b82f6\", \"#f59e0b\", \"#16a34a\", \"#ef4444\"];\n  payload = data || {};\n  totalEl.textContent = String(c(cts.total));\n\n  var statusHtml = \"\";\n  for (var i = 0; i < labels.length; i++) statusHtml += statusRowHtml(labels[i], c(values[i] || 0), colors[i]);\n  listWrap.innerHTML = statusHtml;\n\n  renderCards(data);\n  bindRowClicks();\n  bindTotalClick();\n  renderChart(labels, values, colors);\n}\n\nfunction load() {\n  frappe.call({ method: method, args: args() }).then(function (r) {\n    payload = r.message || {};\n    render(payload);\n  }).catch(function (e) {\n    console.error(\"Department Project Pipeline load failed\", e);\n    chartWrap.innerHTML = \"<div class=\\\"dpp-empty-ring\\\">Load failed</div>\";\n    listWrap.innerHTML = \"\";\n    financeWrap.innerHTML = \"\";\n  });\n}\n\nwindow.addEventListener(\"spd-department-changed\", load);\nload();",
 "style": ".dpp-card{position:relative;background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dpp-title{font-size:18px;font-weight:700;line-height:1.2;margin-bottom:2px}.dpp-sub{color:var(--text-muted);font-size:12px}.dpp-body{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:center;margin-top:8px}.dpp-left{min-height:220px;display:flex;align-items:center;justify-content:center}.dpp-chart{width:100%;max-width:520px}.dpp-empty-ring{display:flex;align-items:center;justify-content:center;min-height:220px;border:1px dashed #d1d5db;border-radius:10px;color:var(--text-muted);font-size:13px}.dpp-right{display:flex;align-items:center}.dpp-status-list{width:100%;display:grid;gap:10px}.dpp-status-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border-color);border-radius:10px;cursor:pointer;transition:all .15s ease;background:var(--card-bg, var(--fg-color))}.dpp-status-row:hover{border-color:#cbd5e1;background:var(--fg-hover-color, #f3f4f6)}.dpp-dot{width:14px;height:14px;border-radius:50%}.dpp-label{font-size:14px;font-weight:600;color:var(--text-color);flex:1}.dpp-val{font-size:16px;font-weight:700;color:var(--text-color)}.dpp-finance-cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:12px}.dpp-fin-card{border:1px solid var(--border-color);border-radius:10px;padding:9px 10px;background:var(--card-bg, var(--fg-color));cursor:pointer;transition:all .15s ease}.dpp-fin-card:hover{transform:translateY(-1px);border-color:var(--primary);background:var(--fg-hover-color, #f3f4f6)}.dpp-fin-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px}.dpp-fin-value{font-size:18px;font-weight:800;color:var(--text-color);line-height:1.25;margin-top:2px;word-break:break-word}.dpp-fin-count{color:#2563eb}.dpp-total{text-align:right;margin-top:10px;font-size:13px;color:var(--text-muted)}.dpp-total-value{font-size:14px;cursor:pointer}@media (max-width:1100px){.dpp-body{grid-template-columns:1fr}.dpp-finance-cards{grid-template-columns:repeat(2,minmax(0,1fr))}.dpp-right{order:2}.dpp-title{font-size:16px}.dpp-sub{font-size:11px}.dpp-label{font-size:13px}.dpp-val{font-size:14px}.dpp-total,.dpp-total-value{font-size:12px}}@media (max-width:640px){.dpp-finance-cards{grid-template-columns:1fr}}"
}
