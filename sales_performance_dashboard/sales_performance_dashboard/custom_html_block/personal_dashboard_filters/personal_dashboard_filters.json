{
 "doctype": "Custom HTML Block",
 "name": "Personal Dashboard Filters",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"psf-wrap\"><div class=\"psf-title\">Dashboard Filters</div><div class=\"psf-grid\"><div class=\"psf-field\"><label>Department</label><select class=\"psf-input psf-department\"></select></div><div class=\"psf-field\"><label>Employee</label><select class=\"psf-input psf-employee\"></select></div><div class=\"psf-field\"><label>View Mode</label><select class=\"psf-input psf-view\"></select></div><div class=\"psf-field\"><label>Risk Window</label><select class=\"psf-input psf-risk\"></select></div></div><div class=\"psf-actions\"><button class=\"btn btn-sm btn-primary psf-apply\">Apply</button><button class=\"btn btn-sm btn-default psf-reset\">Reset</button></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.personal_dashboard_api.get_personal_dashboard_filter_options';\nconst K = { dept: 'spd_personal_dashboard_department', emp: 'spd_personal_dashboard_employee', view: 'spd_personal_view_mode', risk: 'spd_personal_risk_window' };\n\nconst departmentEl = root_element.querySelector('.psf-department');\nconst employeeEl = root_element.querySelector('.psf-employee');\nconst viewEl = root_element.querySelector('.psf-view');\nconst riskEl = root_element.querySelector('.psf-risk');\nconst applyBtn = root_element.querySelector('.psf-apply');\nconst resetBtn = root_element.querySelector('.psf-reset');\n\nfunction setOptions(el, rows, valueKey = 'value', labelKey = 'label') {\n  el.innerHTML = '';\n  (rows || []).forEach((row) => {\n    const o = document.createElement('option');\n    if (typeof row === 'string') {\n      o.value = row;\n      o.textContent = row;\n    } else {\n      o.value = row[valueKey];\n      o.textContent = row[labelKey];\n    }\n    el.appendChild(o);\n  });\n}\n\nfunction readLS(key, fallback = '') {\n  return localStorage.getItem(key) || fallback;\n}\n\nfunction writeFilters() {\n  localStorage.setItem(K.dept, departmentEl.value || '');\n  localStorage.setItem(K.emp, employeeEl.value || '');\n  localStorage.setItem(K.view, viewEl.value || 'Monthly');\n  localStorage.setItem(K.risk, riskEl.value || '14');\n}\n\nfunction refreshEmployees() {\n  const dept = departmentEl.value || '';\n  return frappe.call({ method, args: { department: dept } }).then((r) => {\n    const payload = r.message || {};\n    const emps = payload.employees || [];\n    setOptions(employeeEl, emps.map((e) => ({ value: e.name, label: e.label })));\n\n    const savedEmp = readLS(K.emp, payload.default_employee || '');\n    const exists = emps.some((e) => e.name === savedEmp);\n    employeeEl.value = exists ? savedEmp : (payload.default_employee || (emps[0] && emps[0].name) || '');\n  });\n}\n\nfunction load() {\n  frappe.call({ method }).then((r) => {\n    const payload = r.message || {};\n\n    setOptions(departmentEl, (payload.departments || []).map((d) => ({ value: d, label: d })));\n    setOptions(viewEl, (payload.view_modes || []).map((v) => ({ value: v, label: v })));\n    setOptions(riskEl, (payload.risk_windows || []).map((w) => ({ value: String(w), label: `Next ${w} Days` })));\n\n    departmentEl.value = readLS(K.dept, payload.default_department || '');\n    viewEl.value = readLS(K.view, payload.default_view_mode || 'Monthly');\n    riskEl.value = readLS(K.risk, String(payload.default_risk_window || 14));\n\n    refreshEmployees();\n  });\n}\n\ndepartmentEl.addEventListener('change', () => {\n  localStorage.setItem(K.dept, departmentEl.value || '');\n  refreshEmployees();\n});\n\napplyBtn.addEventListener('click', () => {\n  writeFilters();\n  window.dispatchEvent(new CustomEvent('spd-personal-changed'));\n  // Reload so built-in workspace widgets (charts/number cards) also re-evaluate defaults.\n  window.location.reload();\n});\n\nresetBtn.addEventListener('click', () => {\n  localStorage.removeItem(K.dept);\n  localStorage.removeItem(K.emp);\n  localStorage.removeItem(K.view);\n  localStorage.removeItem(K.risk);\n  load();\n});\n\nload();",
 "style": ".psf-wrap{border:1px solid var(--border-color);border-radius:12px;background:var(--card-bg, var(--fg-color));padding:12px 14px}.psf-title{font-size:18px;font-weight:700;margin-bottom:10px}.psf-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}.psf-field label{display:block;font-size:12px;color:var(--text-muted);font-weight:600;margin-bottom:4px}.psf-input{width:100%;height:38px;border:1px solid var(--border-color);border-radius:10px;padding:0 10px;background:var(--card-bg, var(--fg-color))}.psf-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}.layout-main-section .widget.number-widget-box{border:1px solid var(--border-color)!important;background:var(--card-bg, var(--fg-color))!important}.layout-main-section .widget.number-widget-box .widget-head .widget-title{color:var(--text-muted)!important}.layout-main-section .widget.number-widget-box .widget-body .widget-content .number{color:var(--text-color)!important}@media(max-width:1100px){.psf-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}@media(max-width:700px){.psf-grid{grid-template-columns:1fr}}"
}
