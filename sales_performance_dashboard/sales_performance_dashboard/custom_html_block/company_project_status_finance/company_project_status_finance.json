{
 "doctype": "Custom HTML Block",
 "name": "Company Project Status & Finance",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class='cpsf-card'><div class='cpsf-title'>Project Status & Finance</div><div class='cpsf-sub'>Company project mix, revenue, outstanding, and aging buckets from global filters</div><div class='cpsf-grid'><div class='cpsf-left'><div class='cpsf-ring'></div><div class='cpsf-ring-meta'><span class='cpsf-total-label'>Total Projects</span><b class='cpsf-total-val'>0</b></div></div><div class='cpsf-right'><div class='cpsf-cards'></div></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_project_status_finance';\nconst ringWrap = root_element.querySelector('.cpsf-ring');\nconst cardsWrap = root_element.querySelector('.cpsf-cards');\nconst totalValEl = root_element.querySelector('.cpsf-total-val');\nlet payload = {};\n\nfunction money(v) { return format_currency(v || 0); }\nfunction n(v) { return cint(v || 0); }\n\nfunction args() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n  };\n}\n\nfunction openProjectList(filter) {\n  const routeOptions = {};\n  const selectedCompany = localStorage.getItem('spd_company_dashboard_company') || '';\n  const selectedDepartment = localStorage.getItem('spd_company_dashboard_department') || '';\n  if (selectedCompany) routeOptions.company = selectedCompany;\n  if (selectedDepartment) routeOptions.department = selectedDepartment;\n  if (filter === 'ongoing') routeOptions.status = ['in', ['Open', 'In Progress', 'Working']];\n  if (filter === 'completed') routeOptions.status = 'Completed';\n  frappe.route_options = routeOptions;\n  frappe.set_route('List', 'Project');\n}\n\nfunction openInvoiceList(names, extraFilters = {}) {\n  if (!names || !names.length) {\n    frappe.show_alert({ message: 'No invoices in this scope.', indicator: 'orange' });\n    return;\n  }\n  const routeOptions = { name: ['in', names], ...extraFilters };\n  const selectedCompany = localStorage.getItem('spd_company_dashboard_company') || '';\n  if (selectedCompany) routeOptions.company = selectedCompany;\n  frappe.route_options = routeOptions;\n  frappe.set_route('List', 'Sales Invoice');\n}\n\nfunction onCardClick(key) {\n  const namesByBucket = (payload.bucket_invoice_names || {});\n  switch (key) {\n    case 'status_total': openProjectList('total'); break;\n    case 'status_ongoing': openProjectList('ongoing'); break;\n    case 'status_completed': openProjectList('completed'); break;\n    case 'money_revenue': openInvoiceList(payload.invoice_names_period || []); break;\n    case 'money_outstanding': openInvoiceList(payload.invoice_names_outstanding || [], { outstanding_amount: ['>', 0] }); break;\n    case 'aging_0_30': openInvoiceList(namesByBucket['0-30'] || [], { outstanding_amount: ['>', 0] }); break;\n    case 'aging_31_60': openInvoiceList(namesByBucket['31-60'] || [], { outstanding_amount: ['>', 0] }); break;\n    case 'aging_61_90': openInvoiceList(namesByBucket['61-90'] || [], { outstanding_amount: ['>', 0] }); break;\n    case 'aging_90p': openInvoiceList(namesByBucket['90+'] || [], { outstanding_amount: ['>', 0] }); break;\n  }\n}\n\nfunction bindCardClicks() {\n  cardsWrap.querySelectorAll('.cpsf-card-item').forEach((node) => {\n    node.addEventListener('click', () => onCardClick(node.getAttribute('data-key')));\n  });\n}\n\nfunction renderRing(data) {\n  const total = n(data.total);\n  const ongoing = Math.max(0, Math.min(total, n(data.ongoing)));\n  const completed = Math.max(0, Math.min(total, n(data.completed)));\n\n  const rings = [\n    { label: 'Total Projects', value: total, color: '#3b82f6', fullWhenHasData: true },\n    { label: 'Ongoing Projects', value: ongoing, color: '#f59e0b' },\n    { label: 'Completed Projects', value: completed, color: '#16a34a' },\n  ];\n\n  const size = 260;\n  const center = 130;\n  const arcSpan = 0.86;\n  ringWrap.innerHTML = `<svg class='cpsf-radial' viewBox='0 0 ${size} ${size}'><defs><filter id='cpsfShadow' x='-20%' y='-20%' width='140%' height='140%'><feDropShadow dx='0' dy='2' stdDeviation='2' flood-color='#0f172a' flood-opacity='0.18'></feDropShadow></filter></defs><g class='cpsf-rings'></g></svg>`;\n  const group = ringWrap.querySelector('.cpsf-rings');\n\n  rings.forEach((r, idx) => {\n    const radius = 100 - (idx * 20);\n    const stroke = 14;\n    const circumference = 2 * Math.PI * radius;\n    const trackLen = circumference * arcSpan;\n    const gapLen = circumference - trackLen;\n    const pct = total ? (r.value / total) : 0;\n    const effectivePct = r.fullWhenHasData ? (total > 0 ? 1 : 0) : pct;\n    const valueLen = Math.max(0, Math.min(trackLen, trackLen * effectivePct));\n\n    const track = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\n    track.setAttribute('cx', String(center));\n    track.setAttribute('cy', String(center));\n    track.setAttribute('r', String(radius));\n    track.setAttribute('fill', 'none');\n    track.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--border-color') || '#94a3b8');\n    track.setAttribute('stroke-width', String(stroke));\n    track.setAttribute('stroke-linecap', 'round');\n    track.setAttribute('stroke-dasharray', `${trackLen} ${gapLen}`);\n    track.setAttribute('transform', `rotate(135 ${center} ${center})`);\n    group.appendChild(track);\n\n    const value = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\n    value.setAttribute('cx', String(center));\n    value.setAttribute('cy', String(center));\n    value.setAttribute('r', String(radius));\n    value.setAttribute('fill', 'none');\n    value.setAttribute('stroke', r.color);\n    value.setAttribute('stroke-width', String(stroke));\n    value.setAttribute('stroke-linecap', 'round');\n    value.setAttribute('stroke-dasharray', `${valueLen} ${circumference}`);\n    value.setAttribute('transform', `rotate(135 ${center} ${center})`);\n    value.setAttribute('filter', 'url(#cpsfShadow)');\n    const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');\n    title.textContent = `${r.label}: ${n(r.value)} project(s)`;\n    value.appendChild(title);\n    group.appendChild(value);\n  });\n\n  totalValEl.textContent = total;\n}\n\nfunction renderCards(data) {\n  const c = data.counts || {};\n  const m = data.money || {};\n  const a = data.aging || {};\n  const items = [\n    { key: 'status_total', label: 'Total Projects', value: n(c.total), type: 'count' },\n    { key: 'status_ongoing', label: 'Ongoing Projects', value: n(c.ongoing), type: 'count' },\n    { key: 'status_completed', label: 'Completed Projects', value: n(c.completed), type: 'count' },\n    { key: 'money_revenue', label: 'Total Revenue', value: money(m.total_revenue), type: 'money' },\n    { key: 'money_outstanding', label: 'Outstanding', value: money(m.outstanding), type: 'money' },\n    { key: 'aging_0_30', label: 'Aging 0-30', value: money(a['0-30']), type: 'money' },\n    { key: 'aging_31_60', label: 'Aging 31-60', value: money(a['31-60']), type: 'money' },\n    { key: 'aging_61_90', label: 'Aging 61-90', value: money(a['61-90']), type: 'money' },\n    { key: 'aging_90p', label: 'Aging 90+', value: money(a['90+']), type: 'money' },\n  ];\n\n  cardsWrap.innerHTML = items.map((x) => `\n    <div class='cpsf-card-item' data-key='${x.key}' title='Click to open details'>\n      <div class='cpsf-label'>${frappe.utils.escape_html(x.label)}</div>\n      <div class='cpsf-value ${x.type === 'count' ? 'cpsf-count' : ''}'>${frappe.utils.escape_html(String(x.value))}</div>\n    </div>\n  `).join('');\n  bindCardClicks();\n}\n\nfunction load() {\n  frappe.call({ method, args: args() }).then((r) => {\n    payload = r.message || {};\n    renderRing(payload.counts || {});\n    renderCards(payload);\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cpsf-card{background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.cpsf-title{font-size:20px;font-weight:700}.cpsf-sub{color:var(--text-muted);font-size:12px;margin:2px 0 10px}.cpsf-grid{display:grid;grid-template-columns:minmax(260px,360px) 1fr;gap:16px;align-items:center}.cpsf-left{display:flex;flex-direction:column;align-items:center;gap:8px}.cpsf-ring{width:100%;min-height:240px}.cpsf-radial{width:100%;height:auto;display:block}.cpsf-ring-meta{display:flex;gap:8px;align-items:baseline}.cpsf-total-label{font-size:12px;color:var(--text-muted)}.cpsf-total-val{font-size:28px;color:var(--text-color)}.cpsf-right{display:grid}.cpsf-cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}.cpsf-card-item{border:1px solid var(--border-color);border-radius:10px;padding:10px 12px;background:var(--card-bg, var(--fg-color));cursor:pointer;transition:all .15s ease}.cpsf-card-item:hover{transform:translateY(-1px);border-color:var(--primary);background:var(--fg-hover-color, #f3f4f6)}.cpsf-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px}.cpsf-value{font-size:24px;font-weight:800;color:var(--text-color);line-height:1.2;margin-top:3px;word-break:break-word}.cpsf-count{color:#2563eb}@media (max-width:1200px){.cpsf-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:900px){.cpsf-grid{grid-template-columns:1fr}.cpsf-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:640px){.cpsf-cards{grid-template-columns:1fr}}"
}
