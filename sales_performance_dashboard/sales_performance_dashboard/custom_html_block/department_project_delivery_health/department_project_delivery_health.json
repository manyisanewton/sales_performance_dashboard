{
 "doctype": "Custom HTML Block",
 "name": "Department Project Delivery Health",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class='dpdh-card'><div class='dpdh-title'>Project Delivery Health</div><div class='dpdh-sub'>Department delivery risk, completion, and task pressure by project.</div><div class='dpdh-summary'><div class='dpdh-pill ontrack'>On Track: <b class='dpdh-ontrack'>0</b></div><div class='dpdh-pill atrisk'>At Risk: <b class='dpdh-atrisk'>0</b></div><div class='dpdh-pill overdue'>Overdue: <b class='dpdh-overdue'>0</b></div><div class='dpdh-pill total'>Projects: <b class='dpdh-total'>0</b></div></div><div class='dpdh-table-wrap'><table class='dpdh-table'><thead><tr><th>Project</th><th>Owner</th><th>Planned End</th><th>Health</th><th style='width:150px'>Completion</th><th>Open</th><th>Overdue</th></tr></thead><tbody class='dpdh-body'><tr><td colspan='7' class='dpdh-empty'>Loading...</td></tr></tbody></table></div><div class='dpdh-actions'><button type='button' class='btn btn-sm btn-default dpdh-show-more'>Show More</button></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.department_dashboard_api.get_department_project_delivery_health';\nconst ownerUsersMethod = 'sales_performance_dashboard.api.department_dashboard_api.get_department_owner_users';\nconst body = root_element.querySelector('.dpdh-body');\nconst totalEl = root_element.querySelector('.dpdh-total');\nconst onTrackEl = root_element.querySelector('.dpdh-ontrack');\nconst atRiskEl = root_element.querySelector('.dpdh-atrisk');\nconst overdueEl = root_element.querySelector('.dpdh-overdue');\nconst showMoreBtn = root_element.querySelector('.dpdh-show-more');\nconst storageDepartment = 'spd_department_dashboard_department';\n\nfunction args(){\n  return {\n    department: localStorage.getItem(storageDepartment) || '',\n    limit: 5,\n  };\n}\n\nfunction badgeClass(health) {\n  if (health === 'Overdue') return 'overdue';\n  if (health === 'At Risk') return 'atrisk';\n  return 'ontrack';\n}\n\nfunction fmtDate(v){\n  if (!v) return '-';\n  return frappe.datetime.str_to_user(v);\n}\n\nfunction openProject(name){\n  if (!name) return;\n  frappe.set_route('Form', 'Project', name);\n}\n\nfunction openMore(){\n  const department = localStorage.getItem(storageDepartment) || '';\n  frappe.call({ method: ownerUsersMethod, args: { department } }).then((r) => {\n    const users = r.message || [];\n    const routeOptions = {};\n    if (users.length) {\n      routeOptions.owner = ['in', users];\n    }\n    frappe.route_options = routeOptions;\n    frappe.set_route('List', 'Project');\n  }).catch(() => {\n    frappe.set_route('List', 'Project');\n  });\n}\n\nfunction rowHtml(r){\n  const pct = Math.max(0, Math.min(100, flt(r.completion_pct || 0)));\n  const health = r.health || 'On Track';\n  const ownerName = r.owner_name || '';\n  const initials = (r.owner_initials || '--');\n  return `<tr>\n    <td><button type='button' class='dpdh-link' data-project='${frappe.utils.escape_html(r.project)}'>${frappe.utils.escape_html(r.project_label || r.project || '')}</button></td>\n    <td><span class='dpdh-owner' title='${frappe.utils.escape_html(ownerName)}'><span class='dpdh-avatar'>${frappe.utils.escape_html(initials)}</span><span class='dpdh-owner-name'>${frappe.utils.escape_html(ownerName)}</span></span></td>\n    <td>${fmtDate(r.planned_end_date)}</td>\n    <td><span class='dpdh-badge ${badgeClass(health)}'>${frappe.utils.escape_html(health)}</span></td>\n    <td><div class='dpdh-gauge' style='--dpdh-pct:${pct}'><span>${format_number(pct, null, 1)}%</span></div></td>\n    <td>${cint(r.open_tasks || 0)}</td>\n    <td class='${cint(r.overdue_tasks || 0) > 0 ? 'dpdh-overdue-count' : ''}'>${cint(r.overdue_tasks || 0)}</td>\n  </tr>`;\n}\n\nfunction bindActions(){\n  body.querySelectorAll('.dpdh-link').forEach((btn)=>{\n    btn.addEventListener('click', ()=> openProject(btn.getAttribute('data-project')));\n  });\n  if (showMoreBtn) {\n    showMoreBtn.onclick = openMore;\n  }\n}\n\nfunction render(payload){\n  const summary = payload.summary || {};\n  const rows = payload.rows || [];\n\n  totalEl.textContent = cint(summary.projects || 0);\n  onTrackEl.textContent = cint(summary.on_track || 0);\n  atRiskEl.textContent = cint(summary.at_risk || 0);\n  overdueEl.textContent = cint(summary.overdue || 0);\n\n  if (!rows.length){\n    body.innerHTML = \"<tr><td colspan='7' class='dpdh-empty'>No projects found for selected department.</td></tr>\";\n    bindActions();\n    return;\n  }\n\n  body.innerHTML = rows.map(rowHtml).join('');\n  bindActions();\n}\n\nfunction load(){\n  frappe.call({ method, args: args() }).then((r)=>{\n    render(r.message || {});\n  });\n}\n\nwindow.addEventListener('spd-department-changed', load);\nload();",
 "style": ".dpdh-card{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dpdh-title{font-size:28px;font-weight:700;line-height:1.1}.dpdh-sub{margin-top:4px;color:#6b7280;font-size:16px}.dpdh-summary{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}.dpdh-pill{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;border:1px solid}.dpdh-pill.ontrack{background:#ecfdf3;color:#166534;border-color:#86efac}.dpdh-pill.atrisk{background:#fff7ed;color:#9a3412;border-color:#fdba74}.dpdh-pill.overdue{background:#fef2f2;color:#b91c1c;border-color:#fca5a5}.dpdh-pill.total{background:#f8fafc;color:#334155;border-color:#cbd5e1}.dpdh-table-wrap{overflow:auto}.dpdh-table{width:100%;border-collapse:collapse;font-size:11px}.dpdh-table th,.dpdh-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100);text-align:left;vertical-align:middle}.dpdh-empty{text-align:center;color:var(--text-muted);padding:20px}.dpdh-link{background:none;border:none;padding:0;color:#111827;font-weight:600;cursor:pointer;text-align:left}.dpdh-link:hover{text-decoration:underline}.dpdh-badge{padding:2px 10px;border-radius:999px;font-size:11px;font-weight:600;border:1px solid}.dpdh-badge.ontrack{background:#ecfdf3;color:#166534;border-color:#86efac}.dpdh-badge.atrisk{background:#fff7ed;color:#9a3412;border-color:#fdba74}.dpdh-badge.overdue{background:#fef2f2;color:#b91c1c;border-color:#fca5a5}.dpdh-gauge{width:36px;height:36px;border-radius:50%;background:conic-gradient(#16a34a calc(var(--dpdh-pct)*1%), #e5e7eb 0);display:grid;place-items:center}.dpdh-gauge span{width:28px;height:28px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#334155}.dpdh-overdue-count{color:#dc2626;font-weight:700}.dpdh-owner{display:inline-flex;align-items:center;gap:8px;max-width:220px}.dpdh-avatar{display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;border-radius:999px;background:#e2e8f0;color:#0f172a;font-size:10px;font-weight:700}.dpdh-owner-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dpdh-actions{display:flex;justify-content:flex-end;margin-top:10px}@media (max-width:900px){.dpdh-title{font-size:22px}.dpdh-sub{font-size:13px}.dpdh-table{font-size:10px}}"
}
