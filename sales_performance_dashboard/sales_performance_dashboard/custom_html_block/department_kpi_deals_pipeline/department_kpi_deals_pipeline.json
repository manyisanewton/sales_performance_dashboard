{
 "creation": "2026-02-12 14:06:00.000000",
 "docstatus": 0,
 "doctype": "Custom HTML Block",
 "html": "<div class=\"dkd-wrap\"><h3>Deals &amp; Pipeline</h3><div class=\"dkd-grid dkd-grid-4\"><div class=\"dkd-card\"><div class=\"dkd-label\">TOTAL OPPORTUNITIES</div><div class=\"dkd-val dkd-blue\" data-key=\"total_opportunities\"></div></div><div class=\"dkd-card\"><div class=\"dkd-label\">ONGOING DEALS</div><div class=\"dkd-val dkd-blue\" data-key=\"ongoing_deals\"></div></div><div class=\"dkd-card\"><div class=\"dkd-label\">WON DEALS</div><div class=\"dkd-val dkd-green\" data-key=\"won_deals\"></div></div><div class=\"dkd-card\"><div class=\"dkd-label\">LOST DEALS</div><div class=\"dkd-val dkd-red\" data-key=\"lost_deals\"></div></div></div><div class=\"dkd-grid dkd-grid-4\"><div class=\"dkd-card\"><div class=\"dkd-label\">AVG. DEAL VALUE</div><div class=\"dkd-val dkd-purple\" data-key=\"avg_deal_value\"></div></div><div class=\"dkd-card\"><div class=\"dkd-label\">AVG. WON DEAL VALUE</div><div class=\"dkd-val dkd-green\" data-key=\"avg_won_deal_value\"></div></div><div class=\"dkd-card\"><div class=\"dkd-label\">AVG. TIME TO CLOSE DEAL</div><div class=\"dkd-val dkd-muted\" data-key=\"avg_time_to_close_deal\"></div></div><div class=\"dkd-card\"><div class=\"dkd-label\">AVG. TIME LEAD TO DEAL</div><div class=\"dkd-val dkd-muted\" data-key=\"avg_time_lead_to_deal\"></div></div></div></div>",
 "idx": 0,
 "modified": "2026-02-12 14:06:00.000000",
 "modified_by": "Administrator",
 "module": "Sales Performance Dashboard",
 "name": "Department KPI Deals Pipeline",
 "owner": "Administrator",
 "private": 0,
 "script": "const kpiMethod = \"sales_performance_dashboard.api.department_dashboard_api.get_department_kpis\";\nconst ownerUsersMethod = \"sales_performance_dashboard.api.department_dashboard_api.get_department_owner_users\";\nconst storageKey = 'spd_department_dashboard_department';\nconst riskStorageKey = 'spd_department_risk_window';\nconst storageDate = 'spd_department_reference_date';\n\nconst currencyFields = new Set(['avg_deal_value', 'avg_won_deal_value']);\nconst dayFields = new Set(['avg_time_to_close_deal', 'avg_time_lead_to_deal']);\nlet ownerUsersCache = { department: '', users: [] };\n\nfunction fmt(key, value) {\n  const v = value || 0;\n  if (currencyFields.has(key)) return format_currency(v);\n  if (dayFields.has(key)) return `${cint(v)} days`;\n  return `${cint(v)}`;\n}\n\nfunction render(data) {\n  root_element.querySelectorAll('[data-key]').forEach((el) => {\n    const key = el.getAttribute('data-key');\n    el.textContent = fmt(key, data[key]);\n  });\n}\n\nasync function getOwnerUsers(department) {\n  if (!department) return [];\n  if (ownerUsersCache.department === department && ownerUsersCache.users.length) return ownerUsersCache.users;\n  const r = await frappe.call({ method: ownerUsersMethod, args: { department } });\n  const users = Array.isArray(r.message) ? r.message : [];\n  ownerUsersCache = { department, users };\n  return users;\n}\n\nfunction openList(doctype, filters) {\n  frappe.route_options = filters || {};\n  frappe.set_route('List', doctype);\n}\n\nasync function openSourceByKey(key) {\n  const department = localStorage.getItem(storageKey) || '';\n  const ownerUsers = await getOwnerUsers(department);\n  const ownerFilter = ownerUsers.length ? ['in', ownerUsers] : null;\n  const filters = {};\n  if (ownerFilter) filters.owner = ownerFilter;\n\n  if (key === 'won_deals' || key === 'avg_won_deal_value') {\n    filters.status = ['in', ['Converted', 'Won', 'Closed Won']];\n  } else if (key === 'lost_deals') {\n    filters.status = ['in', ['Lost', 'Closed Lost']];\n  } else if (key === 'ongoing_deals') {\n    filters.status = ['not in', ['Converted', 'Won', 'Closed Won', 'Lost', 'Closed Lost']];\n  }\n\n  return openList('Opportunity', filters);\n}\n\nfunction bindCardClicks() {\n  root_element.querySelectorAll('.dkd-card').forEach((card) => {\n    const keyEl = card.querySelector('[data-key]');\n    if (!keyEl) return;\n    const key = keyEl.getAttribute('data-key');\n    card.classList.add('dkd-clickable');\n    card.title = 'Open source records';\n    card.addEventListener('click', () => openSourceByKey(key));\n  });\n}\n\nfunction loadKpis() {\n  const department = localStorage.getItem(storageKey) || '';\n  const risk_window_days = cint(localStorage.getItem(riskStorageKey) || 14);\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n  frappe.call({ method: kpiMethod, args: { department, risk_window_days, reference_date } }).then((r) => render(r.message || {}));\n}\n\nbindCardClicks();\nwindow.addEventListener('spd-department-changed', loadKpis);\nloadKpis();",
 "style": ".dkd-wrap{display:flex;flex-direction:column;gap:10px}.dkd-wrap h3{margin:0;font-size:24px;font-weight:700}.dkd-grid{display:grid;gap:10px}.dkd-grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}.dkd-card{border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;min-height:82px;background:var(--card-bg, var(--fg-color))}.dkd-card.dkd-clickable{cursor:pointer;transition:all .12s ease}.dkd-card.dkd-clickable:hover{border-color:#cbd5e1;box-shadow:0 4px 14px rgba(15,23,42,.08);transform:translateY(-1px)}.dkd-label{font-size:11px;color:var(--text-muted);font-weight:600;letter-spacing:.3px;margin-bottom:7px}.dkd-val{font-size:20px;font-weight:700;line-height:1.1}.dkd-green{color:#15803d}.dkd-blue{color:#1d4ed8}.dkd-purple{color:#7e22ce}.dkd-red{color:#dc2626}.dkd-muted{color:var(--text-muted)}@media (max-width:1200px){.dkd-grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:768px){.dkd-grid-4{grid-template-columns:1fr}}"
}
