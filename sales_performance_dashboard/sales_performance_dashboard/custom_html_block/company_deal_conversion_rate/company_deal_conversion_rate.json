{
 "doctype": "Custom HTML Block",
 "name": "Company Deal Conversion Rate",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"cdcr-wrap\"><div class=\"cdcr-head\">Deal Conversion Rate</div><div class=\"cdcr-grid\"><div class=\"cdcr-left\"><div class=\"cdcr-gauge-wrap\"><div class=\"cdcr-gauge\"><div class=\"cdcr-progress\"></div><div class=\"cdcr-needle\"></div></div><div class=\"cdcr-scale\"><span>0</span><span>100</span></div><div class=\"cdcr-pct\">0.00%</div><div class=\"cdcr-status\">Weak</div></div></div><div class=\"cdcr-right\"><div class=\"cdcr-right-head\">Highest Value Opportunities</div><div class=\"cdcr-list\"></div></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_deal_conversion_rate';\nconst gaugeEl = root_element.querySelector('.cdcr-gauge');\nconst needleEl = root_element.querySelector('.cdcr-needle');\nconst pctEl = root_element.querySelector('.cdcr-pct');\nconst statusEl = root_element.querySelector('.cdcr-status');\nconst listEl = root_element.querySelector('.cdcr-list');\n\nfunction asCurrency(v) {\n  return format_currency(flt(v || 0));\n}\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n    lead_source: localStorage.getItem('spd_company_dashboard_lead_source') || '',\n  };\n}\n\nfunction renderGauge(data) {\n  const pct = flt(data.conversion_pct || 0);\n  const clamped = Math.max(0, Math.min(pct, 100));\n  const fillDeg = (clamped / 100) * 180;\n  const angle = -90 + fillDeg;\n\n  let color = '#dc2626';\n  let status = 'Weak';\n  if (pct >= 60) {\n    color = '#16a34a';\n    status = 'Healthy';\n  } else if (pct >= 30) {\n    color = '#f59e0b';\n    status = 'Watch';\n  }\n\n  gaugeEl.style.setProperty('--cdcr-fill', `${fillDeg}deg`);\n  gaugeEl.style.setProperty('--cdcr-fill-color', color);\n  needleEl.style.transform = `translateX(-50%) rotate(${angle}deg)`;\n  pctEl.textContent = `${flt(pct, 2).toFixed(2)}%`;\n  pctEl.style.color = color;\n  statusEl.textContent = status;\n  statusEl.style.color = color;\n}\n\nfunction renderTopOpportunities(rows) {\n  const data = rows || [];\n  if (!data.length) {\n    listEl.innerHTML = '<div class=\"cdcr-empty\">No opportunities in current filters.</div>';\n    return;\n  }\n\n  listEl.innerHTML = data.map((row) => `\n    <div class=\"cdcr-row\">\n      <div class=\"cdcr-name\">${frappe.utils.escape_html(row.name || 'Opportunity')}</div>\n      <div class=\"cdcr-amt\">${asCurrency(row.amount)}</div>\n    </div>\n  `).join('');\n}\n\nfunction load() {\n  frappe.call({ method, args: getFilters() }).then((r) => {\n    const data = r.message || {};\n    renderGauge(data);\n    renderTopOpportunities(data.top_opportunities || []);\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cdcr-wrap{background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:10px;padding:14px;box-shadow:0 2px 8px rgba(15,23,42,.06)}.cdcr-head{font-size:16px;font-weight:700;line-height:1.2}.cdcr-grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;align-items:stretch;margin-top:6px}.cdcr-left,.cdcr-right{border:1px solid var(--border-color);border-radius:12px;padding:10px 12px;background:var(--card-bg, var(--fg-color))}.cdcr-gauge-wrap{display:flex;flex-direction:column;align-items:center}.cdcr-gauge{--cdcr-fill:0deg;--cdcr-fill-color:#dc2626;position:relative;width:300px;height:150px;border-top-left-radius:300px;border-top-right-radius:300px;overflow:hidden;background:linear-gradient(90deg,#dc2626 0%,#dc2626 33%,#f59e0b 33%,#f59e0b 66%,#22c55e 66%,#22c55e 100%)}.cdcr-progress{position:absolute;inset:0;border-radius:inherit;background:conic-gradient(from 180deg at 50% 100%,var(--cdcr-fill-color) 0deg var(--cdcr-fill),transparent var(--cdcr-fill) 360deg)}.cdcr-gauge::after{content:'';position:absolute;left:50%;bottom:-90px;transform:translateX(-50%);width:200px;height:200px;border-radius:50%;background:var(--card-bg, var(--fg-color));z-index:2}.cdcr-needle{position:absolute;left:50%;bottom:0;transform:translateX(-50%) rotate(-90deg);transform-origin:50% 100%;width:5px;height:105px;background:#475569;border-radius:6px;z-index:3;transition:transform .28s ease}.cdcr-needle::after{content:'';position:absolute;left:50%;bottom:-9px;transform:translateX(-50%);width:18px;height:18px;border-radius:50%;background:#475569}.cdcr-scale{width:300px;display:flex;justify-content:space-between;color:var(--text-muted);font-size:14px;font-weight:500;margin-top:6px}.cdcr-pct{margin-top:4px;font-size:30px;font-weight:700;color:var(--text-muted);line-height:1}.cdcr-status{margin-top:2px;font-size:13px;font-weight:700}.cdcr-right-head{font-size:13px;font-weight:700;margin-bottom:6px;color:var(--text-color)}.cdcr-list{display:flex;flex-direction:column;gap:0}.cdcr-row{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px solid var(--border-color)}.cdcr-row:last-child{border-bottom:none}.cdcr-name{color:var(--text-color);font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cdcr-amt{color:var(--text-color);font-size:12px;font-weight:700}.cdcr-empty{color:var(--text-muted);font-size:12px;padding:8px 0}@media (max-width:1200px){.cdcr-grid{grid-template-columns:1fr}.cdcr-right-head{font-size:13px}}@media (max-width:900px){.cdcr-head{font-size:15px}.cdcr-gauge{width:240px;height:120px}.cdcr-scale{width:240px;font-size:13px}.cdcr-pct{font-size:26px}.cdcr-status{font-size:12px}}"
}
