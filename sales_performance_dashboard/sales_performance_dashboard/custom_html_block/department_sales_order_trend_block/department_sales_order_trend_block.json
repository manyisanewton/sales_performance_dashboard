{
 "doctype": "Custom HTML Block",
 "name": "Department Sales Order Trend Block",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"dsd-trend-card\"><div class=\"dsd-trend-header\">Department Sales Order Trend</div><div class=\"dsd-trend-sub\">Sales amount and order count for selected department</div><div class=\"dsd-trend-wrap\"><div class=\"dsd-trend-chart\"></div><div class=\"dsd-trend-right-axis\"></div></div></div>",
 "script": "const method = \"sales_performance_dashboard.sales_performance_dashboard.dashboard_chart_source.department_sales_order_trend.department_sales_order_trend.get_data_for_custom\";\nconst storageDepartment = 'spd_department_dashboard_department';\nconst storageView = 'spd_department_view_mode';\nconst storageDate = 'spd_department_reference_date';\nconst chartRoot = root_element.querySelector('.dsd-trend-chart');\nconst rightAxis = root_element.querySelector('.dsd-trend-right-axis');\nconst sub = root_element.querySelector('.dsd-trend-sub');\nlet chart = null;\nlet lastOrderScale = 1;\n\nfunction toNumber(v) {\n  const n = Number(v || 0);\n  return Number.isFinite(n) ? n : 0;\n}\n\nfunction setRightAxisFixed100() {\n  const ticks = [100, 80, 60, 40, 20, 0];\n  rightAxis.innerHTML = ticks.map((v) => `<div class=\"dsd-trend-right-tick\">${v}</div>`).join('');\n}\n\nfunction prepareDualAxisData(raw) {\n  const labels = Array.isArray(raw.labels) ? raw.labels : [];\n  const datasets = Array.isArray(raw.datasets) ? raw.datasets : [];\n\n  const amountSeries = datasets[0] || { name: 'Sales Amount', values: [] };\n  const orderSeries = datasets[1] || { name: 'Sales Orders', values: [] };\n\n  const amountValues = (amountSeries.values || []).map(toNumber);\n  const orderValues = (orderSeries.values || []).map(toNumber);\n\n  const amountMax = amountValues.reduce((m, v) => Math.max(m, v), 0);\n  const leftRangeBase = amountMax > 0 ? amountMax : 1;\n  lastOrderScale = leftRangeBase / 100;\n\n  const scaledOrders = orderValues.map((v) => v * lastOrderScale);\n  setRightAxisFixed100();\n\n  return {\n    labels,\n    datasets: [\n      { name: amountSeries.name || 'Sales Amount', values: amountValues },\n      { name: orderSeries.name || 'Sales Orders', values: scaledOrders }\n    ]\n  };\n}\n\nfunction formatTooltipY(value, dataset) {\n  const n = toNumber(value);\n  const dsName = (dataset && dataset.name) || '';\n\n  if (dsName === 'Sales Orders') {\n    return String(Math.max(0, Math.round(n / (lastOrderScale || 1))));\n  }\n\n  return format_currency(n);\n}\n\nfunction load() {\n  const department = localStorage.getItem(storageDepartment) || '';\n  const view_mode = localStorage.getItem(storageView) || 'Monthly';\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n\n  frappe.call({ method, args: { department, view_mode, reference_date } })\n    .then((r) => {\n      const raw = r.message || { labels: [], datasets: [] };\n      const data = prepareDualAxisData(raw);\n      sub.textContent = 'Sales amount (left axis) and sales order count (right axis: 0-100)';\n\n      if (!chart) {\n        chart = new frappe.Chart(chartRoot, {\n          data,\n          type: 'line',\n          height: 280,\n          colors: ['#ef6fa1', '#2f7fd0'],\n          axisOptions: { xIsSeries: 1, xAxisMode: 'tick' },\n          lineOptions: { regionFill: 0 },\n          tooltipOptions: { formatTooltipY }\n        });\n      } else {\n        chart.update(data);\n      }\n    })\n    .catch(() => {\n      sub.textContent = 'Could not load trend data';\n      setRightAxisFixed100();\n    });\n}\n\nwindow.addEventListener('spd-department-changed', load);\nload();",
 "style": ".dsd-trend-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px 14px 10px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dsd-trend-header{font-size:16px;font-weight:700;margin-bottom:2px}.dsd-trend-sub{color:var(--text-muted);font-size:11px;margin-bottom:8px}.dsd-trend-wrap{position:relative;padding-right:44px}.dsd-trend-chart{min-height:280px}.dsd-trend-right-axis{position:absolute;top:14px;right:0;bottom:36px;width:40px;display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end;pointer-events:none}.dsd-trend-right-tick{font-size:10px;color:#4b5563;line-height:1;white-space:nowrap}"
}
