{
 "doctype": "Custom HTML Block",
 "name": "Department Weighted Pipeline Coverage",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"dwpc-wrap\"><div class=\"dwpc-head\"><h3>Weighted Pipeline Coverage</h3><p>Weighted pipeline vs current-period target.</p></div><div class=\"dwpc-gauge-wrap\"><div class=\"dwpc-gauge\"><div class=\"dwpc-needle\"></div><div class=\"dwpc-center\"><div class=\"dwpc-pct\">0.00%</div><div class=\"dwpc-status\">No Target</div></div></div><div class=\"dwpc-scale\"><span>0%</span><span>70%</span><span>100%</span><span>150%+</span></div></div><div class=\"dwpc-cards\"><div class=\"dwpc-card\"><div class=\"dwpc-label\">WEIGHTED PIPELINE</div><div class=\"dwpc-value\" data-key=\"weighted_pipeline\"></div></div><div class=\"dwpc-card\"><div class=\"dwpc-label\" data-key=\"next_target_label\">CURRENT TARGET</div><div class=\"dwpc-value\" data-key=\"next_target\"></div></div><div class=\"dwpc-card\"><div class=\"dwpc-label\">GAP / SURPLUS</div><div class=\"dwpc-value\" data-key=\"gap\"></div></div></div></div>",
 "script": "const method = \"sales_performance_dashboard.api.department_dashboard_api.get_department_weighted_pipeline_coverage\";\nconst storageDepartment = 'spd_department_dashboard_department';\nconst storageView = 'spd_department_view_mode';\nconst storageDate = 'spd_department_reference_date';\n\nconst gaugeEl = root_element.querySelector('.dwpc-gauge');\nconst needleEl = root_element.querySelector('.dwpc-needle');\nconst pctEl = root_element.querySelector('.dwpc-pct');\nconst statusEl = root_element.querySelector('.dwpc-status');\n\nfunction asCurrency(v) { return format_currency(flt(v || 0)); }\n\nfunction setValue(key, val) {\n  const el = root_element.querySelector(`[data-key=\"${key}\"]`);\n  if (!el) return;\n\n  if (key === 'next_target_label') {\n    el.textContent = (val || 'Current Target').toUpperCase();\n    return;\n  }\n\n  if (key === 'gap') {\n    el.textContent = asCurrency(val);\n    el.style.color = flt(val || 0) < 0 ? '#dc2626' : '#15803d';\n    return;\n  }\n\n  el.textContent = asCurrency(val);\n}\n\nfunction renderGauge(data) {\n  const pct = flt(data.coverage_pct || 0);\n  const clamped = Math.max(0, Math.min(pct, 150));\n  const ratio = clamped / 150;\n  const angle = -90 + (ratio * 180);\n\n  needleEl.style.transform = `translateX(-50%) rotate(${angle}deg)`;\n  pctEl.textContent = `${flt(pct, 2).toFixed(2)}%`;\n  statusEl.textContent = data.status || 'No Target';\n\n  let toneClass = 'weak';\n  let toneColor = '#dc2626';\n  const s = (data.status || '').toLowerCase();\n  if (s === 'healthy') {\n    toneClass = 'healthy';\n    toneColor = '#15803d';\n  } else if (s === 'watch') {\n    toneClass = 'watch';\n    toneColor = '#d97706';\n  } else if (s === 'no target') {\n    toneClass = 'no_target';\n    toneColor = 'var(--text-muted)';\n  } else if (pct >= 130) {\n    toneClass = 'strong';\n    toneColor = '#0f766e';\n  }\n\n  statusEl.classList.remove('weak', 'watch', 'healthy', 'strong', 'no_target');\n  statusEl.classList.add(toneClass);\n  pctEl.style.color = toneColor;\n\n  gaugeEl.classList.remove('stage-weak', 'stage-watch', 'stage-healthy', 'stage-strong', 'stage-no_target');\n  gaugeEl.classList.add(`stage-${toneClass}`);\n}\n\nfunction load() {\n  const department = localStorage.getItem(storageDepartment) || '';\n  const view_mode = localStorage.getItem(storageView) || 'Monthly';\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n\n  frappe.call({ method, args: { department, view_mode, reference_date } }).then((r) => {\n    const data = r.message || {};\n    renderGauge(data);\n    setValue('weighted_pipeline', data.weighted_pipeline);\n    setValue('next_target_label', data.next_target_label);\n    setValue('next_target', data.next_target);\n    setValue('gap', data.gap);\n  });\n}\n\nwindow.addEventListener('spd-department-changed', load);\nload();",
 "style": ".dwpc-wrap{background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dwpc-head h3{margin:0;font-size:18px;font-weight:700}.dwpc-head p{margin:2px 0 10px;font-size:12px;color:var(--text-muted)}.dwpc-gauge-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}.dwpc-gauge{position:relative;width:320px;height:160px;border-top-left-radius:320px;border-top-right-radius:320px;overflow:hidden;background:conic-gradient(from 180deg at 50% 100%,#dc2626 0 36deg,#f59e0b 36deg 78deg,#22c55e 78deg 138deg,#0f766e 138deg 180deg)}.dwpc-gauge::after{content:'';position:absolute;left:50%;bottom:-105px;transform:translateX(-50%);width:220px;height:220px;border-radius:50%;background:var(--card-bg, var(--fg-color))}.dwpc-needle{position:absolute;left:50%;bottom:0;transform:translateX(-50%) rotate(-90deg);transform-origin:50% 100%;width:4px;height:120px;background:var(--text-color);border-radius:4px;z-index:3;transition:transform .3s ease}.dwpc-needle::after{content:'';position:absolute;left:50%;bottom:-7px;transform:translateX(-50%);width:16px;height:16px;border-radius:50%;background:var(--text-color)}.dwpc-center{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);text-align:center;z-index:4}.dwpc-pct{font-size:20px;font-weight:800}.dwpc-status{font-size:12px;font-weight:700}.dwpc-status.weak{color:#dc2626}.dwpc-status.watch{color:#d97706}.dwpc-status.healthy{color:#15803d}.dwpc-status.strong{color:#0f766e}.dwpc-status.no_target{color:var(--text-muted)}.dwpc-scale{width:320px;display:flex;justify-content:space-between;font-size:11px}.dwpc-scale span:nth-child(1){color:#dc2626}.dwpc-scale span:nth-child(2){color:#d97706}.dwpc-scale span:nth-child(3){color:#15803d}.dwpc-scale span:nth-child(4){color:#0f766e}.dwpc-cards{margin-top:10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}.dwpc-card{border:1px solid var(--border-color);border-radius:12px;padding:10px 12px;background:var(--card-bg, var(--fg-color))}.dwpc-label{font-size:11px;color:var(--text-muted);font-weight:600;letter-spacing:.3px;margin-bottom:6px}.dwpc-value{font-size:20px;font-weight:700;line-height:1.1}@media (max-width:900px){.dwpc-cards{grid-template-columns:1fr}.dwpc-gauge{width:280px;height:140px}.dwpc-scale{width:280px}}"
}
