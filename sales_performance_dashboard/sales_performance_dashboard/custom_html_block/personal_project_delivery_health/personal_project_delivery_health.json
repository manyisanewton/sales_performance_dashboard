{
 "doctype": "Custom HTML Block",
 "name": "Personal Project Delivery Health",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class='ppdh-card'><div class='ppdh-title'>Project Delivery Health</div><div class='ppdh-sub'>Planned end date risk, task completion, and delivery pressure by project.</div><div class='ppdh-summary'><div class='ppdh-pill ontrack'>On Track: <b class='ppdh-ontrack'>0</b></div><div class='ppdh-pill atrisk'>At Risk: <b class='ppdh-atrisk'>0</b></div><div class='ppdh-pill overdue'>Overdue: <b class='ppdh-overdue'>0</b></div><div class='ppdh-pill total'>Projects: <b class='ppdh-total'>0</b></div></div><div class='ppdh-table-wrap'><table class='ppdh-table'><thead><tr><th>Project</th><th>Planned End</th><th>Health</th><th style='width:150px'>Completion</th><th>Open Tasks</th><th>Overdue Tasks</th></tr></thead><tbody class='ppdh-body'><tr><td colspan='6' class='ppdh-empty'>Loading...</td></tr></tbody></table></div><div class='ppdh-actions'><button type='button' class='btn btn-sm btn-default ppdh-show-more'>Show More</button></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.personal_dashboard_api.get_personal_project_delivery_health';\nconst body = root_element.querySelector('.ppdh-body');\nconst totalEl = root_element.querySelector('.ppdh-total');\nconst onTrackEl = root_element.querySelector('.ppdh-ontrack');\nconst atRiskEl = root_element.querySelector('.ppdh-atrisk');\nconst overdueEl = root_element.querySelector('.ppdh-overdue');\nconst showMoreBtn = root_element.querySelector('.ppdh-show-more');\nlet scopeUser = '';\n\nfunction args() {\n  return {\n    department: localStorage.getItem('spd_personal_dashboard_department') || '',\n    employee: localStorage.getItem('spd_personal_dashboard_employee') || '',\n    limit: 5,\n  };\n}\n\nfunction badgeClass(health) {\n  if (health === 'Overdue') return 'overdue';\n  if (health === 'At Risk') return 'atrisk';\n  return 'ontrack';\n}\n\nfunction fmtDate(v) {\n  if (!v) return '-';\n  return frappe.datetime.str_to_user(v);\n}\n\nfunction openProject(name) {\n  if (!name) return;\n  frappe.set_route('Form', 'Project', name);\n}\n\nfunction openMore() {\n  frappe.route_options = { owner: scopeUser || frappe.session.user };\n  frappe.set_route('List', 'Project');\n}\n\nfunction rowHtml(r) {\n  const pct = Math.max(0, Math.min(100, flt(r.completion_pct || 0)));\n  const health = r.health || 'On Track';\n  return `<tr>\n    <td><button type='button' class='ppdh-link' data-project='${frappe.utils.escape_html(r.project)}'>${frappe.utils.escape_html(r.project_label || r.project || '')}</button></td>\n    <td>${fmtDate(r.planned_end_date)}</td>\n    <td><span class='ppdh-badge ${badgeClass(health)}'>${frappe.utils.escape_html(health)}</span></td>\n    <td>\n      <div class='ppdh-gauge' style='--ppdh-pct:${pct}'>\n        <span>${format_number(pct, null, 1)}%</span>\n      </div>\n    </td>\n    <td>${cint(r.open_tasks || 0)}</td>\n    <td class='${cint(r.overdue_tasks || 0) > 0 ? 'ppdh-overdue-count' : ''}'>${cint(r.overdue_tasks || 0)}</td>\n  </tr>`;\n}\n\nfunction bindActions() {\n  body.querySelectorAll('.ppdh-link').forEach((btn) => {\n    btn.addEventListener('click', () => openProject(btn.getAttribute('data-project')));\n  });\n  if (showMoreBtn) {\n    showMoreBtn.onclick = openMore;\n  }\n}\n\nfunction render(payload) {\n  const summary = payload.summary || {};\n  const rows = payload.rows || [];\n  scopeUser = (payload.scope && payload.scope.user) || frappe.session.user;\n\n  totalEl.textContent = cint(summary.projects || 0);\n  onTrackEl.textContent = cint(summary.on_track || 0);\n  atRiskEl.textContent = cint(summary.at_risk || 0);\n  overdueEl.textContent = cint(summary.overdue || 0);\n\n  if (!rows.length) {\n    body.innerHTML = \"<tr><td colspan='6' class='ppdh-empty'>No projects found for selected scope.</td></tr>\";\n    bindActions();\n    return;\n  }\n\n  body.innerHTML = rows.map(rowHtml).join('');\n  bindActions();\n}\n\nfunction load() {\n  frappe.call({ method, args: args() }).then((r) => {\n    render(r.message || {});\n  });\n}\n\nwindow.addEventListener('spd-personal-changed', load);\nload();",
 "style": ".ppdh-card{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.ppdh-title{font-size:20px;font-weight:700}.ppdh-sub{color:var(--text-muted);font-size:12px;margin:2px 0 10px}.ppdh-summary{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}.ppdh-pill{font-size:12px;border-radius:999px;padding:4px 10px;border:1px solid var(--gray-300);background:#fff}.ppdh-pill.ontrack{color:#166534;border-color:#86efac;background:#f0fdf4}.ppdh-pill.atrisk{color:#9a3412;border-color:#fdba74;background:#fff7ed}.ppdh-pill.overdue{color:#991b1b;border-color:#fda4af;background:#fff1f2}.ppdh-pill.total{color:#1f2937}.ppdh-table-wrap{overflow:auto}.ppdh-table{width:100%;border-collapse:collapse}.ppdh-table th,.ppdh-table td{padding:8px 10px;border-top:1px solid var(--gray-200);font-size:13px;white-space:nowrap;vertical-align:middle}.ppdh-table th{font-size:12px;text-transform:uppercase;letter-spacing:.02em;color:var(--text-muted)}.ppdh-empty{text-align:center;color:var(--text-muted)}.ppdh-link{appearance:none;border:0;background:transparent;padding:0;color:var(--primary);font-weight:600;cursor:pointer;text-align:left}.ppdh-link:hover{text-decoration:underline}.ppdh-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700;border:1px solid transparent}.ppdh-badge.ontrack{color:#166534;background:#f0fdf4;border-color:#86efac}.ppdh-badge.atrisk{color:#9a3412;background:#fff7ed;border-color:#fdba74}.ppdh-badge.overdue{color:#991b1b;background:#fff1f2;border-color:#fda4af}.ppdh-gauge{--ppdh-pct:0;position:relative;width:34px;height:34px;border-radius:50%;background:conic-gradient(#16a34a calc(var(--ppdh-pct) * 1%), #e5e7eb 0)}.ppdh-gauge::after{content:'';position:absolute;inset:4px;background:#fff;border-radius:50%}.ppdh-gauge span{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#334155;z-index:1}.ppdh-overdue-count{color:#dc2626;font-weight:700}.ppdh-actions{display:flex;justify-content:flex-end;margin-top:10px}"
}
