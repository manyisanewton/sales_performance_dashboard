{
 "doctype": "Custom HTML Block",
 "name": "Company Gross Margin Trend",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"cgmt-wrap\"><div class=\"cgmt-title\">Gross Margin % Trend</div><div class=\"cgmt-sub\">Company-wide margin trend (Sales - COGS). Uses global filters and can split by all departments.</div><div class=\"cgmt-chart\"></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_gross_margin_trend';\nconst chartRoot = root_element.querySelector('.cgmt-chart');\nconst subEl = root_element.querySelector('.cgmt-sub');\nlet chart = null;\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n  };\n}\n\nfunction pct(v) {\n  return `${Number(v || 0).toFixed(2)}%`;\n}\n\nfunction load() {\n  const args = getFilters();\n  frappe.call({ method, args }).then((r) => {\n    const payload = r.message || {};\n    const data = {\n      labels: payload.labels || [],\n      datasets: (payload.datasets || []).map((d) => ({\n        name: d.name,\n        values: d.values || [],\n      })),\n    };\n\n    subEl.textContent = args.department\n      ? `Gross margin trend for ${args.department}.`\n      : 'Overall company gross margin trend.';\n\n    if (!chart) {\n      chart = new frappe.Chart(chartRoot, {\n        data,\n        type: 'line',\n        height: 320,\n        colors: ['#16a34a'],\n        lineOptions: { regionFill: 0, hideDots: 0, heatline: 0 },\n        axisOptions: { xIsSeries: 1, xAxisMode: 'tick' },\n        tooltipOptions: {\n          formatTooltipY: (v) => `${pct(v)} Gross Margin`,\n        },\n      });\n      return;\n    }\n\n    chart.update(data);\n  }).catch(() => {\n    subEl.textContent = 'Could not load gross margin trend data.';\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cgmt-wrap{display:flex;flex-direction:column;gap:8px;background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.cgmt-title{font-size:34px;font-weight:800;line-height:1.1;letter-spacing:-.01em;color:var(--text-color)}.cgmt-sub{font-size:13px;color:var(--text-muted)}.cgmt-chart{min-height:320px}.cgmt-chart .graph-stats-container,.cgmt-chart .stats,.cgmt-chart .chart-legend,.cgmt-chart .graph-legend{display:none!important}.crbs-wrap .chart-container svg text,.cgmt-wrap .chart-container svg text,.cpov-wrap .chart-container svg text{fill:var(--text-muted)!important}"
}
