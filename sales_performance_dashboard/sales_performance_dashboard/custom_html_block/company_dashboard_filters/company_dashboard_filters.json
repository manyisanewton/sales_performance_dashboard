{
 "doctype": "Custom HTML Block",
 "name": "Company Dashboard Filters",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"csd-filter-wrap\"><div class=\"csd-filter-title\">Global Filters</div><div class=\"csd-filter-row\"><div class=\"csd-filter\"><label>Company</label><select class=\"csd-filter-company\"></select></div><div class=\"csd-filter\"><label>Department (Optional)</label><select class=\"csd-filter-department\"></select></div><div class=\"csd-filter\"><label>View Mode</label><select class=\"csd-filter-view\"></select></div><div class=\"csd-filter\"><label>Reference Date</label><input type=\"date\" class=\"csd-filter-date\" /></div><div class=\"csd-filter\"><label>Lead Source (Optional)</label><select class=\"csd-filter-source\"></select></div><div class=\"csd-filter\"><label>Risk Window</label><select class=\"csd-filter-risk\"></select></div></div></div>",
 "script": "const optionsMethod = 'sales_performance_dashboard.api.company_dashboard_api.get_company_filter_options';\nconst storageCompany = 'spd_company_dashboard_company';\nconst storageDepartment = 'spd_company_dashboard_department';\nconst storageView = 'spd_company_dashboard_view_mode';\nconst storageDate = 'spd_company_dashboard_reference_date';\nconst storageSource = 'spd_company_dashboard_lead_source';\nconst storageRisk = 'spd_company_dashboard_risk_window';\n\nconst companyEl = root_element.querySelector('.csd-filter-company');\nconst departmentEl = root_element.querySelector('.csd-filter-department');\nconst viewEl = root_element.querySelector('.csd-filter-view');\nconst dateEl = root_element.querySelector('.csd-filter-date');\nconst sourceEl = root_element.querySelector('.csd-filter-source');\nconst riskEl = root_element.querySelector('.csd-filter-risk');\n\nfunction setOptions(el, values, placeholder='All') {\n  const head = `<option value=\"\">${frappe.utils.escape_html(placeholder)}</option>`;\n  const body = (values || []).map((v) => `<option value=\"${frappe.utils.escape_html(v)}\">${frappe.utils.escape_html(v)}</option>`).join('');\n  el.innerHTML = head + body;\n}\n\nfunction setNumericOptions(el, values) {\n  el.innerHTML = (values || []).map((v) => `<option value=\"${cint(v)}\">Next ${cint(v)} Days</option>`).join('');\n}\n\nfunction emitCompanyChanged() {\n  const payload = {\n    company: companyEl.value || '',\n    department: departmentEl.value || '',\n    view_mode: viewEl.value || 'Monthly',\n    reference_date: dateEl.value || frappe.datetime.get_today(),\n    lead_source: sourceEl.value || '',\n    risk_window_days: cint(riskEl.value || 14),\n  };\n\n  localStorage.setItem(storageCompany, payload.company);\n  localStorage.setItem(storageDepartment, payload.department);\n  localStorage.setItem(storageView, payload.view_mode);\n  localStorage.setItem(storageDate, payload.reference_date);\n  localStorage.setItem(storageSource, payload.lead_source);\n  localStorage.setItem(storageRisk, String(payload.risk_window_days));\n\n  window.dispatchEvent(new CustomEvent('spd-company-changed', { detail: payload }));\n}\n\nfunction bind() {\n  [companyEl, departmentEl, viewEl, dateEl, sourceEl, riskEl].forEach((el) => {\n    el.addEventListener('change', emitCompanyChanged);\n  });\n}\n\nfrappe.call({ method: optionsMethod }).then((r) => {\n  const opts = r.message || {};\n  setOptions(companyEl, opts.companies || [], 'Select company...');\n  setOptions(departmentEl, opts.departments || [], 'All departments');\n  setOptions(sourceEl, opts.lead_sources || [], 'All sources');\n  setOptions(viewEl, opts.view_modes || ['Daily','Monthly','Quarterly','Yearly'], 'Monthly');\n  setNumericOptions(riskEl, opts.risk_windows || [7,14,30]);\n\n  const savedCompany = localStorage.getItem(storageCompany);\n  const savedDepartment = localStorage.getItem(storageDepartment);\n  const savedView = localStorage.getItem(storageView);\n  const savedDate = localStorage.getItem(storageDate);\n  const savedSource = localStorage.getItem(storageSource);\n  const savedRisk = localStorage.getItem(storageRisk);\n\n  if (savedCompany) companyEl.value = savedCompany;\n  if (!companyEl.value && (opts.companies || []).length) companyEl.value = opts.companies[0];\n\n  if (savedDepartment) departmentEl.value = savedDepartment;\n  if (savedSource) sourceEl.value = savedSource;\n\n  viewEl.value = (savedView && (opts.view_modes || []).includes(savedView)) ? savedView : 'Monthly';\n  dateEl.value = savedDate || frappe.datetime.get_today();\n\n  const defaultRisk = cint(opts.default_risk_window || 14);\n  riskEl.value = savedRisk || String(defaultRisk);\n\n  bind();\n  emitCompanyChanged();\n});",
 "style": ".csd-filter-wrap{display:flex;flex-direction:column;gap:8px;background:#fff;border:1px solid var(--gray-200);border-radius:12px;padding:12px 14px}.csd-filter-title{font-size:14px;font-weight:700;color:var(--text-color)}.csd-filter-row{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}.csd-filter{display:flex;flex-direction:column;gap:6px}.csd-filter label{margin:0;font-size:11px;font-weight:600;color:#6b7280}.csd-filter select,.csd-filter input{height:34px;border:1px solid #d1d5db;border-radius:8px;padding:6px 10px;font-size:13px}@media (max-width:1400px){.csd-filter-row{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (max-width:768px){.csd-filter-row{grid-template-columns:1fr}}"
}
