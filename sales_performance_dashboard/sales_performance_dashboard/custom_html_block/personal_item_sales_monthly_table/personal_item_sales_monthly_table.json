{
 "doctype": "Custom HTML Block",
 "name": "Personal Item Sales (Monthly) Table",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"psd-item-table-card\"><div class=\"psd-item-table-header\">Personal Item Sales (Monthly)</div><div class=\"psd-item-table-sub\">Top items by billed amount this month</div><div class=\"psd-item-table-wrap\"><table class=\"psd-item-table\"><thead><tr><th style=\"width:70px\">#</th><th>Item</th><th style=\"text-align:right\">Amount</th></tr></thead><tbody class=\"psd-item-table-body\"><tr><td colspan=\"3\" class=\"psd-item-table-empty\">Loading...</td></tr></tbody></table></div><div class=\"psd-item-table-actions\"><button type=\"button\" class=\"btn btn-sm btn-secondary psd-item-table-more\" style=\"display:none\">Show more</button></div></div>",
 "script": "const method = \"sales_performance_dashboard.sales_performance_dashboard.dashboard_chart_source.personal_item_sales_monthly.personal_item_sales_monthly.get_table_data_for_custom\";\nconst PAGE_SIZE = 5;\nconst body = root_element.querySelector('.psd-item-table-body');\nconst showMoreBtn = root_element.querySelector('.psd-item-table-more');\n\nlet offset = 0;\nlet hasMore = false;\nlet loading = false;\n\nfunction money(value) {\n\treturn format_currency(value || 0);\n}\n\nfunction args(start = 0, page_length = PAGE_SIZE) {\n\treturn {\n\t\tdepartment: localStorage.getItem('spd_personal_dashboard_department') || '',\n\t\temployee: localStorage.getItem('spd_personal_dashboard_employee') || '',\n\t\tstart,\n\t\tpage_length,\n\t};\n}\n\nfunction openItem(itemCode) {\n\tif (!itemCode) return;\n\tfrappe.set_route('Form', 'Item', itemCode);\n}\n\nfunction rowHtml(row) {\n\tconst itemName = frappe.utils.escape_html(row.item_name || '');\n\tconst itemCode = frappe.utils.escape_html(row.item_code || '');\n\treturn `<tr class=\\\"psd-item-table-row\\\" data-item-code=\\\"${itemCode}\\\" title=\\\"Open item details\\\"><td>${row.rank}</td><td>${itemName}</td><td style=\\\"text-align:right\\\">${money(row.amount)}</td></tr>`;\n}\n\nfunction renderNoData(message) {\n\tbody.innerHTML = `<tr><td colspan=\\\"3\\\" class=\\\"psd-item-table-empty\\\">${message}</td></tr>`;\n}\n\nfunction syncShowMore() {\n\tshowMoreBtn.style.display = hasMore ? 'inline-flex' : 'none';\n\tshowMoreBtn.disabled = loading;\n\tshowMoreBtn.textContent = loading ? 'Loading...' : 'Show more';\n}\n\nfunction loadPage(append = false) {\n\tif (loading) return;\n\tloading = true;\n\tsyncShowMore();\n\n\tfrappe.call({ method, args: args(offset, PAGE_SIZE) })\n\t\t.then((r) => {\n\t\t\tconst payload = r.message || {};\n\t\t\tconst rows = payload.rows || [];\n\t\t\thasMore = !!payload.has_more;\n\n\t\t\tif (!append) {\n\t\t\t\tif (!rows.length) {\n\t\t\t\t\toffset = 0;\n\t\t\t\t\trenderNoData('No data for this month');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbody.innerHTML = rows.map((row) => rowHtml(row)).join('');\n\t\t\t} else if (rows.length) {\n\t\t\t\tbody.insertAdjacentHTML('beforeend', rows.map((row) => rowHtml(row)).join(''));\n\t\t\t}\n\n\t\t\toffset += rows.length;\n\t\t})\n\t\t.catch(() => {\n\t\t\tif (!append) {\n\t\t\t\toffset = 0;\n\t\t\t\thasMore = false;\n\t\t\t\trenderNoData('Could not load data');\n\t\t\t}\n\t\t})\n\t\t.finally(() => {\n\t\t\tloading = false;\n\t\t\tsyncShowMore();\n\t\t});\n}\n\nfunction reload() {\n\toffset = 0;\n\thasMore = false;\n\tloading = false;\n\tbody.innerHTML = '<tr><td colspan=\\\"3\\\" class=\\\"psd-item-table-empty\\\">Loading...</td></tr>';\n\tsyncShowMore();\n\tloadPage(false);\n}\n\nbody.addEventListener('click', (e) => {\n\tconst row = e.target.closest('tr.psd-item-table-row[data-item-code]');\n\tif (!row) return;\n\topenItem(row.getAttribute('data-item-code'));\n});\n\nshowMoreBtn.addEventListener('click', () => loadPage(true));\nwindow.addEventListener('spd-personal-changed', reload);\nreload();\n",
 "style": ".psd-item-table-card{position:relative;background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px 14px 10px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.psd-item-table-header{font-size:16px;font-weight:700;margin-bottom:2px}.psd-item-table-sub{color:var(--text-muted);font-size:11px;margin-bottom:8px}.psd-item-table-wrap{overflow:auto;max-height:420px}.psd-item-table{width:100%;border-collapse:collapse;font-size:12px}.psd-item-table th,.psd-item-table td{padding:8px 10px;border-bottom:1px solid var(--gray-100)}.psd-item-table thead th{position:sticky;top:0;background:#fff;z-index:1}.psd-item-table-empty{text-align:center;color:var(--text-muted);padding:16px}.psd-item-table-actions{display:flex;justify-content:flex-end;padding-top:10px}.psd-item-table-more{min-width:96px;justify-content:center}.psd-item-table-row{cursor:pointer}.psd-item-table-row:hover td{background:#f8fafc}"
}
