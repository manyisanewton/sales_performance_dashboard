{
 "doctype": "Custom HTML Block",
 "name": "Company Pipeline Overview",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"cpov-wrap\"><div class=\"cpov-head\"><h3>Pipeline Overview</h3><p>CRM opportunity flow and deal outcomes for selected company filters.</p><div class=\"cpov-range\"></div></div><div class=\"cpov-grid\"><div class=\"cpov-card\"><div class=\"cpov-title\">Pipeline Funnel</div><div class=\"cpov-sub\">Lead \u2192 Opportunity \u2192 Quotation \u2192 Customer \u2192 Sales Order \u2192 Delivery Note \u2192 Sales Invoice</div><svg class=\"cpov-funnel\" viewBox=\"0 0 420 270\" preserveAspectRatio=\"xMidYMin meet\"></svg><div class=\"cpov-legend cpov-funnel-legend\"></div></div><div class=\"cpov-card\"><div class=\"cpov-title\">Deal Status Mix</div><div class=\"cpov-sub\">Open vs Won vs Lost vs Other</div><div class=\"cpov-donut\"></div><div class=\"cpov-legend cpov-donut-legend\"></div></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_pipeline_overview';\nconst colors = ['#2dd4bf', '#f43f5e', '#f59e0b', '#84cc16', '#22c55e', '#0ea5e9', '#6366f1'];\nconst donutColors = ['#2563eb', '#16a34a', '#dc2626', '#64748b'];\n\nconst funnelSvg = root_element.querySelector('.cpov-funnel');\nconst funnelLegend = root_element.querySelector('.cpov-funnel-legend');\nconst donutRoot = root_element.querySelector('.cpov-donut');\nconst donutLegend = root_element.querySelector('.cpov-donut-legend');\nconst rangeEl = root_element.querySelector('.cpov-range');\nlet donutChart = null;\n\nfunction asInt(v) {\n  return cint(v || 0);\n}\n\nfunction renderLegend(el, labels, values, palette) {\n  el.innerHTML = (labels || []).map((label, i) => `\n    <div class=\"cpov-legend-item\">\n      <span class=\"cpov-dot\" style=\"background:${palette[i % palette.length]}\"></span>\n      <span class=\"cpov-name\">${frappe.utils.escape_html(label)}</span>\n      <span class=\"cpov-val\">${asInt(values[i])}</span>\n    </div>\n  `).join('');\n}\n\nfunction blend(hex, pct) {\n  const c = (hex || '#000000').replace('#', '');\n  const n = parseInt(c, 16);\n  let r = (n >> 16) & 255;\n  let g = (n >> 8) & 255;\n  let b = n & 255;\n  const t = pct < 0 ? 0 : 255;\n  const p = Math.abs(pct);\n  r = Math.round((t - r) * p + r);\n  g = Math.round((t - g) * p + g);\n  b = Math.round((t - b) * p + b);\n  return `rgb(${r}, ${g}, ${b})`;\n}\n\nfunction renderFunnel(labels, values) {\n  const safeVals = (values || []).map(asInt);\n  const max = Math.max(...safeVals, 1);\n  const minW = 90;\n  const maxW = 330;\n  const h = 42;\n  const gap = 5;\n  const totalH = (labels.length * (h + gap)) + gap + 2;\n  funnelSvg.setAttribute('viewBox', `0 0 420 ${totalH}`);\n  funnelSvg.innerHTML = '';\n\n  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');\n  const shadow = document.createElementNS('http://www.w3.org/2000/svg', 'filter');\n  shadow.setAttribute('id', 'cpovFunnelShadow');\n  shadow.setAttribute('x', '-20%');\n  shadow.setAttribute('y', '-20%');\n  shadow.setAttribute('width', '140%');\n  shadow.setAttribute('height', '160%');\n  const feDrop = document.createElementNS('http://www.w3.org/2000/svg', 'feDropShadow');\n  feDrop.setAttribute('dx', '0');\n  feDrop.setAttribute('dy', '3');\n  feDrop.setAttribute('stdDeviation', '2.2');\n  feDrop.setAttribute('flood-color', '#0f172a');\n  feDrop.setAttribute('flood-opacity', '0.25');\n  shadow.appendChild(feDrop);\n  defs.appendChild(shadow);\n\n  colors.forEach((base, i) => {\n    const grad = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');\n    grad.setAttribute('id', `cpovGrad${i}`);\n    grad.setAttribute('x1', '0%');\n    grad.setAttribute('y1', '0%');\n    grad.setAttribute('x2', '0%');\n    grad.setAttribute('y2', '100%');\n\n    const s1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n    s1.setAttribute('offset', '0%');\n    s1.setAttribute('stop-color', blend(base, 0.28));\n    const s2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n    s2.setAttribute('offset', '55%');\n    s2.setAttribute('stop-color', base);\n    const s3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');\n    s3.setAttribute('offset', '100%');\n    s3.setAttribute('stop-color', blend(base, -0.18));\n\n    grad.appendChild(s1);\n    grad.appendChild(s2);\n    grad.appendChild(s3);\n    defs.appendChild(grad);\n  });\n  funnelSvg.appendChild(defs);\n\n  let y = gap;\n  for (let i = 0; i < labels.length; i++) {\n    const current = safeVals[i];\n    const next = safeVals[i + 1] ?? safeVals[i];\n    const width = minW + (current / max) * (maxW - minW);\n    const nextWidth = minW + (next / max) * (maxW - minW);\n    const x = (420 - width) / 2;\n    const nx = (420 - nextWidth) / 2;\n\n    const topY = y + 8;\n    const bottomY = y + h - 8;\n    const d = `M ${x} ${topY} Q ${x + width / 2} ${y - 2} ${x + width} ${topY} L ${nx + nextWidth} ${bottomY} Q ${nx + nextWidth / 2} ${y + h + 4} ${nx} ${bottomY} Z`;\n\n    const seg = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n    seg.setAttribute('d', d);\n    seg.setAttribute('fill', `url(#cpovGrad${i % colors.length})`);\n    seg.setAttribute('filter', 'url(#cpovFunnelShadow)');\n\n    const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');\n    title.textContent = `${labels[i]}: ${current}`;\n    seg.appendChild(title);\n    funnelSvg.appendChild(seg);\n\n    const cap = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');\n    cap.setAttribute('cx', String(x + width / 2));\n    cap.setAttribute('cy', String(topY));\n    cap.setAttribute('rx', String(Math.max(8, width / 2 - 6)));\n    cap.setAttribute('ry', '5.5');\n    cap.setAttribute('fill', 'rgba(255,255,255,0.22)');\n    funnelSvg.appendChild(cap);\n\n    y += h + gap;\n  }\n\n  renderLegend(funnelLegend, labels, safeVals, colors);\n}\n\nfunction renderDonut(labels, values) {\n  const data = {\n    labels,\n    datasets: [{ values }],\n  };\n\n  if (!donutChart) {\n    donutChart = new frappe.Chart(donutRoot, {\n      data,\n      type: 'donut',\n      height: 280,\n      colors: donutColors,\n      showLegend: false,\n    });\n  } else {\n    donutChart.update(data);\n  }\n\n  renderLegend(donutLegend, labels, values, donutColors);\n}\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n    lead_source: localStorage.getItem('spd_company_dashboard_lead_source') || '',\n  };\n}\n\nfunction load() {\n  const args = getFilters();\n  frappe.call({ method, args }).then((r) => {\n    const data = r.message || {};\n    const funnel = data.funnel || {};\n    const dealStatus = data.deal_status || {};\n\n    renderFunnel(funnel.labels || [], funnel.values || []);\n    renderDonut(dealStatus.labels || [], dealStatus.values || []);\n\n    const fromDate = data.from_date ? frappe.datetime.str_to_user(data.from_date) : '-';\n    const toDate = data.to_date ? frappe.datetime.str_to_user(data.to_date) : '-';\n    rangeEl.textContent = `Period: ${fromDate} to ${toDate}`;\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cpov-wrap{display:flex;flex-direction:column;gap:10px;background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.cpov-head h3{margin:0;font-size:22px;font-weight:800;letter-spacing:-.01em}.cpov-head p{margin:2px 0 0 0;font-size:13px;color:var(--text-muted)}.cpov-range{margin-top:6px;font-size:12px;font-weight:600;color:var(--text-muted)}.cpov-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}.cpov-card{border:1px solid var(--border-color);border-radius:12px;padding:10px 12px;background:var(--card-bg, var(--fg-color))}.cpov-title{font-size:15px;font-weight:700;color:var(--text-color)}.cpov-sub{font-size:11px;color:var(--text-muted);margin-bottom:8px}.cpov-funnel{display:block;width:100%;max-width:440px;height:auto;margin:0 auto 8px}.cpov-donut{min-height:280px}.cpov-legend{display:grid;grid-template-columns:1fr 1fr;gap:6px}.cpov-legend-item{display:flex;align-items:center;gap:6px;font-size:12px}.cpov-dot{width:9px;height:9px;border-radius:999px;display:inline-block}.cpov-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cpov-val{font-weight:700;color:var(--text-color)}@media (max-width:960px){.cpov-grid{grid-template-columns:1fr}.cpov-legend{grid-template-columns:1fr}}.cpov-donut .graph-stats-container,.cpov-donut [class*='stats'],.cpov-donut .stats,.cpov-donut .chart-legend,.cpov-donut ul,.cpov-donut .graph-legend,.cpov-donut .frappe-chart .graph-stats-container{display:none!important}.crbs-wrap .chart-container svg text,.cgmt-wrap .chart-container svg text,.cpov-wrap .chart-container svg text{fill:var(--text-muted)!important}"
}
