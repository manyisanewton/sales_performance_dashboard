{
 "doctype": "Custom HTML Block",
 "name": "Personal Project Status & Finance",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class='ppsf-card'><div class='ppsf-title'>Project Status & Finance</div><div class='ppsf-sub'>Projects, revenue, and receivable aging in one view</div><div class='ppsf-grid'><div class='ppsf-left'><div class='ppsf-ring'></div><div class='ppsf-ring-meta'><span class='ppsf-total-label'>Total Projects</span><b class='ppsf-total-val'>0</b></div></div><div class='ppsf-right'><div class='ppsf-cards'></div></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.personal_dashboard_api.get_personal_project_status_finance';\nconst ringWrap = root_element.querySelector('.ppsf-ring');\nconst cardsWrap = root_element.querySelector('.ppsf-cards');\nconst totalValEl = root_element.querySelector('.ppsf-total-val');\nlet payload = {};\n\nfunction money(v) { return format_currency(v || 0); }\nfunction n(v) { return cint(v || 0); }\n\nfunction args() {\n  return {\n    department: localStorage.getItem('spd_personal_dashboard_department') || '',\n    employee: localStorage.getItem('spd_personal_dashboard_employee') || '',\n    view_mode: localStorage.getItem('spd_personal_view_mode') || 'Monthly',\n    reference_date: frappe.datetime.get_today(),\n  };\n}\n\nfunction openProjectList(filter) {\n  const routeOptions = { owner: (payload.scope && payload.scope.user) || frappe.session.user };\n  if (filter === 'ongoing') routeOptions.status = ['in', ['Open', 'In Progress', 'Working']];\n  if (filter === 'completed') routeOptions.status = 'Completed';\n  frappe.route_options = routeOptions;\n  frappe.set_route('List', 'Project');\n}\n\nfunction openInvoiceList(names, extraFilters = {}) {\n  if (!names || !names.length) {\n    frappe.show_alert({ message: 'No invoices in this scope.', indicator: 'orange' });\n    return;\n  }\n  const routeOptions = {\n    name: ['in', names],\n    ...extraFilters,\n  };\n  frappe.route_options = routeOptions;\n  frappe.set_route('List', 'Sales Invoice');\n}\n\nfunction onCardClick(key) {\n  const namesByBucket = (payload.bucket_invoice_names || {});\n  switch (key) {\n    case 'status_total':\n      openProjectList('total');\n      break;\n    case 'status_ongoing':\n      openProjectList('ongoing');\n      break;\n    case 'status_completed':\n      openProjectList('completed');\n      break;\n    case 'money_revenue':\n      openInvoiceList(payload.invoice_names_period || []);\n      break;\n    case 'money_outstanding':\n      openInvoiceList(payload.invoice_names_outstanding || [], { outstanding_amount: ['>', 0] });\n      break;\n    case 'aging_0_30':\n      openInvoiceList(namesByBucket['0-30'] || [], { outstanding_amount: ['>', 0] });\n      break;\n    case 'aging_31_60':\n      openInvoiceList(namesByBucket['31-60'] || [], { outstanding_amount: ['>', 0] });\n      break;\n    case 'aging_61_90':\n      openInvoiceList(namesByBucket['61-90'] || [], { outstanding_amount: ['>', 0] });\n      break;\n    case 'aging_90p':\n      openInvoiceList(namesByBucket['90+'] || [], { outstanding_amount: ['>', 0] });\n      break;\n  }\n}\n\nfunction bindCardClicks() {\n  cardsWrap.querySelectorAll('.ppsf-card-item').forEach((node) => {\n    node.addEventListener('click', () => onCardClick(node.getAttribute('data-key')));\n  });\n}\n\nfunction renderRing(data) {\n  const total = n(data.total);\n  const ongoing = Math.max(0, Math.min(total, n(data.ongoing)));\n  const completed = Math.max(0, Math.min(total, n(data.completed)));\n  const other = Math.max(0, total - ongoing - completed);\n\n  ringWrap.innerHTML = '';\n  new frappe.Chart(ringWrap, {\n    type: 'donut',\n    height: 240,\n    showLegend: 0,\n    data: {\n      labels: ['Ongoing', 'Completed', 'Other'],\n      datasets: [{ values: [ongoing, completed, other] }],\n    },\n    colors: ['#3b82f6', '#16a34a', '#f59e0b'],\n    tooltipOptions: {\n      formatTooltipY: (v) => `${n(v)} project(s)`,\n    },\n  });\n\n  ringWrap.querySelectorAll('.graph-stats-container, .stats, .chart-legend').forEach((el) => {\n    el.style.display = 'none';\n  });\n\n  totalValEl.textContent = total;\n}\n\nfunction renderCards(data) {\n  const c = data.counts || {};\n  const m = data.money || {};\n  const a = data.aging || {};\n\n  const items = [\n    { key: 'status_total', label: 'Total Projects', value: n(c.total), type: 'count' },\n    { key: 'status_ongoing', label: 'Ongoing Projects', value: n(c.ongoing), type: 'count' },\n    { key: 'status_completed', label: 'Completed Projects', value: n(c.completed), type: 'count' },\n    { key: 'money_revenue', label: 'Total Revenue', value: money(m.total_revenue), type: 'money' },\n    { key: 'money_outstanding', label: 'Outstanding', value: money(m.outstanding), type: 'money' },\n    { key: 'aging_0_30', label: 'Aging 0-30', value: money(a['0-30']), type: 'money' },\n    { key: 'aging_31_60', label: 'Aging 31-60', value: money(a['31-60']), type: 'money' },\n    { key: 'aging_61_90', label: 'Aging 61-90', value: money(a['61-90']), type: 'money' },\n    { key: 'aging_90p', label: 'Aging 90+', value: money(a['90+']), type: 'money' },\n  ];\n\n  cardsWrap.innerHTML = items.map((x) => `\n    <div class='ppsf-card-item' data-key='${x.key}' title='Click to open details'>\n      <div class='ppsf-label'>${frappe.utils.escape_html(x.label)}</div>\n      <div class='ppsf-value ${x.type === 'count' ? 'ppsf-count' : ''}'>${frappe.utils.escape_html(String(x.value))}</div>\n    </div>\n  `).join('');\n\n  bindCardClicks();\n}\n\nfunction load() {\n  frappe.call({ method, args: args() }).then((r) => {\n    payload = r.message || {};\n    renderRing(payload.counts || {});\n    renderCards(payload);\n  });\n}\n\nwindow.addEventListener('spd-personal-changed', load);\nload();",
 "style": ".ppsf-card{background:var(--card-bg, var(--fg-color));border:1px solid var(--border-color);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.ppsf-title{font-size:20px;font-weight:700}.ppsf-sub{color:var(--text-muted);font-size:12px;margin:2px 0 10px}.ppsf-grid{display:grid;grid-template-columns:minmax(260px,360px) 1fr;gap:16px;align-items:center}.ppsf-left{display:flex;flex-direction:column;align-items:center;gap:8px}.ppsf-ring{width:100%;min-height:240px}.ppsf-ring .graph-stats-container,.ppsf-ring .stats,.ppsf-ring .chart-legend{display:none!important}.ppsf-ring-meta{display:flex;gap:8px;align-items:baseline}.ppsf-total-label{font-size:12px;color:var(--text-muted)}.ppsf-total-val{font-size:28px;color:var(--text-color)}.ppsf-right{display:grid}.ppsf-cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}.ppsf-card-item{border:1px solid var(--border-color);border-radius:10px;padding:10px 12px;background:var(--card-bg, var(--fg-color));cursor:pointer;transition:all .15s ease}.ppsf-card-item:hover{transform:translateY(-1px);border-color:var(--primary);background:var(--fg-hover-color, #f3f4f6)}.ppsf-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px}.ppsf-value{font-size:24px;font-weight:800;color:var(--text-color);line-height:1.2;margin-top:3px;word-break:break-word}.ppsf-count{color:#2563eb}@media (max-width:1200px){.ppsf-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:900px){.ppsf-grid{grid-template-columns:1fr}.ppsf-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:640px){.ppsf-cards{grid-template-columns:1fr}}"
}
