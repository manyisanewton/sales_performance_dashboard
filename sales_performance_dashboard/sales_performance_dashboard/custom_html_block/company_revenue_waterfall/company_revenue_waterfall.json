{
 "doctype": "Custom HTML Block",
 "name": "Company Revenue Waterfall",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"crwf-wrap\"><div class=\"crwf-head\"><h3>Revenue Waterfall + Target Overlay</h3><p>Target, revenue flow, and risk in one visual.</p><div class=\"crwf-range\"></div></div><div class=\"crwf-grid\"><div class=\"crwf-panel\"><div class=\"crwf-title\">Waterfall</div><svg class=\"crwf-svg\" viewBox=\"0 0 760 320\" preserveAspectRatio=\"xMidYMin meet\"></svg></div><div class=\"crwf-panel\"><div class=\"crwf-title\">Collected / Outstanding / At Risk</div><div class=\"crwf-donut\"></div><div class=\"crwf-legend\"></div></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_revenue_waterfall';\nconst svg = root_element.querySelector('.crwf-svg');\nconst donutRoot = root_element.querySelector('.crwf-donut');\nconst legendEl = root_element.querySelector('.crwf-legend');\nconst rangeEl = root_element.querySelector('.crwf-range');\nlet donutChart = null;\n\nfunction asCurrency(v) { return format_currency(flt(v || 0)); }\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n    lead_source: localStorage.getItem('spd_company_dashboard_lead_source') || '',\n    risk_window_days: cint(localStorage.getItem('spd_company_dashboard_risk_window') || 14),\n  };\n}\n\nfunction renderLegend(rows) {\n  legendEl.innerHTML = rows.map((r) => `\n    <div class=\"crwf-li\">\n      <span class=\"crwf-dot\" style=\"background:${r.color}\"></span>\n      <span class=\"crwf-n\">${r.name}</span>\n      <span class=\"crwf-v\">${asCurrency(r.value)}</span>\n    </div>\n  `).join('');\n}\n\nfunction renderDonut(payload) {\n  const collected = flt(payload.total_collected);\n  const outstanding = flt(payload.total_outstanding);\n  const atRisk = flt(payload.revenue_at_risk);\n  const notAtRisk = Math.max(0, outstanding - atRisk);\n\n  const labels = ['Collected', 'Outstanding (Not at Risk)', 'At Risk'];\n  const values = [collected, notAtRisk, atRisk];\n  const colors = ['#16a34a', '#f59e0b', '#dc2626'];\n\n  const data = { labels, datasets: [{ values }] };\n  if (!donutChart) {\n    donutChart = new frappe.Chart(donutRoot, {\n      data,\n      type: 'donut',\n      height: 280,\n      colors,\n      showLegend: false,\n    });\n  } else {\n    donutChart.update(data);\n  }\n\n  renderLegend([\n    { name: 'Collected', value: collected, color: colors[0] },\n    { name: 'Outstanding (Not at Risk)', value: notAtRisk, color: colors[1] },\n    { name: `At Risk (${payload.risk_window_days}d)`, value: atRisk, color: colors[2] },\n  ]);\n}\n\nfunction renderWaterfall(payload) {\n  const target = flt(payload.monthly_target || 0);\n  const revenue = flt(payload.total_revenue || 0);\n  const outstanding = flt(payload.total_outstanding || 0);\n  const collected = flt(payload.total_collected || (revenue - outstanding));\n\n  const bars = [\n    { key: 'Target', start: 0, end: target, color: '#3b82f6' },\n    { key: '+ Revenue', start: target, end: target + revenue, color: '#8b5cf6' },\n    { key: '- Outstanding', start: target + revenue, end: target + collected, color: '#f59e0b' },\n    { key: 'Net Position', start: 0, end: target + collected, color: '#16a34a' },\n  ];\n\n  const allVals = bars.flatMap((b) => [b.start, b.end]);\n  const maxVal = Math.max(...allVals, 1);\n  const minVal = Math.min(...allVals, 0);\n\n  const W = 760; const H = 320;\n  const pad = { l: 64, r: 18, t: 24, b: 58 };\n  const cw = W - pad.l - pad.r;\n  const ch = H - pad.t - pad.b;\n\n  function y(v) {\n    const ratio = (v - minVal) / (maxVal - minVal || 1);\n    return pad.t + (1 - ratio) * ch;\n  }\n\n  const baseY = y(0);\n  const bw = Math.min(110, cw / bars.length - 16);\n  const gap = (cw - (bw * bars.length)) / (bars.length + 1);\n\n  let out = '';\n  out += `<line x1='${pad.l}' y1='${baseY}' x2='${W - pad.r}' y2='${baseY}' stroke='#cbd5e1' stroke-width='1'/>`;\n\n  const targetY = y(target);\n  out += `<line x1='${pad.l}' y1='${targetY}' x2='${W - pad.r}' y2='${targetY}' stroke='#3b82f6' stroke-dasharray='6 4' stroke-width='1.5'/>`;\n  out += `<text x='${W - pad.r - 4}' y='${targetY - 6}' text-anchor='end' fill='#3b82f6' font-size='11' font-weight='700'>Target</text>`;\n\n  bars.forEach((b, i) => {\n    const x = pad.l + gap + i * (bw + gap);\n    const top = Math.min(y(b.start), y(b.end));\n    const h = Math.max(2, Math.abs(y(b.start) - y(b.end)));\n    const delta = b.end - b.start;\n    const isAbsoluteBar = (b.key === 'Target' || b.key === 'Net Position');\n    const label = isAbsoluteBar\n      ? format_currency(b.end)\n      : `${delta >= 0 ? '+' : '-'} ${format_currency(Math.abs(delta))}`;\n\n    out += `<rect x='${x}' y='${top}' width='${bw}' height='${h}' rx='6' ry='6' fill='${b.color}' opacity='0.92'/>`;\n    out += `<text x='${x + bw / 2}' y='${H - 26}' text-anchor='middle' fill='#475569' font-size='11' font-weight='600'>${b.key}</text>`;\n    out += `<text x='${x + bw / 2}' y='${top - 6}' text-anchor='middle' fill='#334155' font-size='10'>${frappe.utils.escape_html(label)}</text>`;\n  });\n\n  svg.innerHTML = out;\n}\n\nfunction load() {\n  frappe.call({ method, args: getFilters() }).then((r) => {\n    const payload = r.message || {};\n    renderWaterfall(payload);\n    renderDonut(payload);\n    const fromDate = payload.from_date ? frappe.datetime.str_to_user(payload.from_date) : '-';\n    const toDate = payload.to_date ? frappe.datetime.str_to_user(payload.to_date) : '-';\n    rangeEl.textContent = `Period: ${fromDate} to ${toDate}`;\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".crwf-wrap{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.crwf-head h3{margin:0;font-size:20px;font-weight:800}.crwf-head p{margin:2px 0 0 0;font-size:12px;color:var(--text-muted)}.crwf-range{margin-top:6px;font-size:12px;color:#475569;font-weight:600}.crwf-grid{margin-top:10px;display:grid;grid-template-columns:2fr 1fr;gap:12px}.crwf-panel{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px}.crwf-title{font-size:14px;font-weight:700;color:#1e293b;margin-bottom:8px}.crwf-svg{width:100%;height:auto;display:block}.crwf-donut{min-height:280px}.crwf-legend{display:grid;grid-template-columns:1fr;gap:6px}.crwf-li{display:flex;align-items:center;gap:7px;font-size:12px}.crwf-dot{width:9px;height:9px;border-radius:999px;display:inline-block}.crwf-n{flex:1;color:#334155}.crwf-v{font-weight:700;color:#0f172a}@media (max-width:1100px){.crwf-grid{grid-template-columns:1fr}}.crwf-donut .graph-stats-container,.crwf-donut [class*='stats'],.crwf-donut .stats,.crwf-donut .chart-legend,.crwf-donut ul,.crwf-donut .graph-legend,.crwf-donut .frappe-chart .graph-stats-container{display:none!important}"
}
