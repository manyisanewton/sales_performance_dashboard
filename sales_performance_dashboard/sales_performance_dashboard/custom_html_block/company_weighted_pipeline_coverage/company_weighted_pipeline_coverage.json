{
 "doctype": "Custom HTML Block",
 "name": "Company Weighted Pipeline Coverage",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"cwpw-wrap\"><div class=\"cwpw-head\"><h3>Weighted Pipeline Coverage</h3><p>Weighted pipeline vs next-period company target.</p></div><div class=\"cwpw-gauge-wrap\"><div class=\"cwpw-gauge\"><div class=\"cwpw-needle\"></div><div class=\"cwpw-center\"><div class=\"cwpw-pct\">0.00%</div><div class=\"cwpw-status\">No Target</div></div></div><div class=\"cwpw-scale\"><span>0%</span><span>70%</span><span>100%</span><span>150%+</span></div></div><div class=\"cwpw-cards\"><div class=\"cwpw-card\"><div class=\"cwpw-label\">WEIGHTED PIPELINE</div><div class=\"cwpw-value\" data-key=\"weighted_pipeline\"></div></div><div class=\"cwpw-card\"><div class=\"cwpw-label\" data-key=\"next_target_label\">NEXT TARGET</div><div class=\"cwpw-value\" data-key=\"next_target\"></div></div><div class=\"cwpw-card\"><div class=\"cwpw-label\">GAP / SURPLUS</div><div class=\"cwpw-value\" data-key=\"gap\"></div></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_weighted_pipeline_coverage';\nconst needleEl = root_element.querySelector('.cwpw-needle');\nconst pctEl = root_element.querySelector('.cwpw-pct');\nconst statusEl = root_element.querySelector('.cwpw-status');\n\nfunction asCurrency(v) { return format_currency(flt(v || 0)); }\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n    lead_source: localStorage.getItem('spd_company_dashboard_lead_source') || '',\n  };\n}\n\nfunction setValue(key, val) {\n  const el = root_element.querySelector(`[data-key=\"${key}\"]`);\n  if (!el) return;\n\n  if (key === 'next_target_label') {\n    el.textContent = (val || 'Next Target').toUpperCase();\n    return;\n  }\n\n  if (key === 'gap') {\n    el.textContent = asCurrency(val);\n    el.style.color = flt(val || 0) < 0 ? '#dc2626' : '#15803d';\n    return;\n  }\n\n  el.textContent = asCurrency(val);\n}\n\nfunction renderGauge(data) {\n  const pct = flt(data.coverage_pct || 0);\n  const clamped = Math.max(0, Math.min(pct, 150));\n  const ratio = clamped / 150;\n  const angle = -90 + (ratio * 180);\n\n  needleEl.style.transform = `translateX(-50%) rotate(${angle}deg)`;\n  pctEl.textContent = `${flt(pct, 2).toFixed(2)}%`;\n  statusEl.textContent = data.status || 'No Target';\n\n  statusEl.classList.remove('weak', 'watch', 'healthy');\n  const s = (data.status || '').toLowerCase();\n  if (s === 'healthy') statusEl.classList.add('healthy');\n  else if (s === 'watch') statusEl.classList.add('watch');\n  else statusEl.classList.add('weak');\n}\n\nfunction load() {\n  frappe.call({ method, args: getFilters() }).then((r) => {\n    const data = r.message || {};\n    renderGauge(data);\n    setValue('weighted_pipeline', data.weighted_pipeline);\n    setValue('next_target_label', data.next_target_label);\n    setValue('next_target', data.next_target);\n    setValue('gap', data.gap);\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cwpw-wrap{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.cwpw-head h3{margin:0;font-size:18px;font-weight:700}.cwpw-head p{margin:2px 0 10px;font-size:12px;color:var(--text-muted)}.cwpw-gauge-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}.cwpw-gauge{position:relative;width:300px;height:150px;border-top-left-radius:300px;border-top-right-radius:300px;overflow:hidden;background:linear-gradient(90deg,#dc2626 0%,#dc2626 33%,#f59e0b 33%,#f59e0b 66%,#22c55e 66%,#22c55e 100%)}.cwpw-gauge::after{content:'';position:absolute;left:50%;bottom:-90px;transform:translateX(-50%);width:200px;height:200px;border-radius:50%;background:#fff}.cwpw-needle{position:absolute;left:50%;bottom:0;transform:translateX(-50%) rotate(-90deg);transform-origin:50% 100%;width:4px;height:108px;background:#111827;border-radius:4px;z-index:3;transition:transform .3s ease}.cwpw-needle::after{content:'';position:absolute;left:50%;bottom:-7px;transform:translateX(-50%);width:16px;height:16px;border-radius:50%;background:#111827}.cwpw-center{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);text-align:center;z-index:4}.cwpw-pct{font-size:20px;font-weight:800}.cwpw-status{font-size:12px;font-weight:700}.cwpw-status.weak{color:#dc2626}.cwpw-status.watch{color:#d97706}.cwpw-status.healthy{color:#15803d}.cwpw-scale{width:300px;display:flex;justify-content:space-between;font-size:11px;color:#64748b}.cwpw-cards{margin-top:10px;display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}.cwpw-card{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}.cwpw-label{font-size:11px;color:#52525b;font-weight:600;letter-spacing:.3px;margin-bottom:6px}.cwpw-value{font-size:16px;font-weight:700;line-height:1.2}@media (max-width:1200px){.cwpw-cards{grid-template-columns:1fr}}@media (max-width:900px){.cwpw-gauge{width:250px;height:125px}.cwpw-scale{width:250px}}"
}
