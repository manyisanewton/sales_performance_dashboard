{
 "doctype": "Custom HTML Block",
 "name": "Personal Project Pipeline",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class='psp-card'><div class='psp-title'>Personal Project Pipeline</div><div class='psp-sub'>Project status mix for selected user scope</div><div class='psp-body'><div class='psp-left'><div class='psp-chart'></div></div><div class='psp-right'><div class='psp-status-list'></div></div></div><div class='psp-finance-cards'></div><div class='psp-total'>Total Projects: <b class='psp-total-value' title='Open all projects'>0</b></div></div>",
 "script": "var method = \"sales_performance_dashboard.api.personal_dashboard_api.get_personal_project_status_finance\";\nvar chartWrap = root_element.querySelector(\".psp-chart\");\nvar totalEl = root_element.querySelector(\".psp-total-value\");\nvar listWrap = root_element.querySelector(\".psp-status-list\");\nvar financeWrap = root_element.querySelector(\".psp-finance-cards\");\nvar payload = {};\n\nfunction args() {\n  return {\n    department: localStorage.getItem(\"spd_personal_dashboard_department\") || \"\",\n    employee: localStorage.getItem(\"spd_personal_dashboard_employee\") || \"\",\n    view_mode: localStorage.getItem(\"spd_personal_view_mode\") || \"Monthly\",\n    reference_date: frappe.datetime.get_today(),\n  };\n}\n\nfunction money(v) {\n  var num = Number(v || 0);\n  if (isNaN(num)) num = 0;\n  if (typeof format_currency === \"function\") return format_currency(num);\n  return \"Sh \" + num.toFixed(2);\n}\n\nfunction c(v) {\n  var num = Number(v || 0);\n  if (isNaN(num)) num = 0;\n  return Math.max(0, Math.round(num));\n}\n\nfunction openProjectList(filter) {\n  var routeOptions = { owner: (payload.scope && payload.scope.user) || frappe.session.user };\n  if (filter === \"ongoing\") routeOptions.status = [\"in\", [\"Open\", \"In Progress\", \"Working\"]];\n  if (filter === \"completed\") routeOptions.status = \"Completed\";\n  if (filter === \"cancelled\") routeOptions.status = \"Cancelled\";\n  frappe.route_options = routeOptions;\n  frappe.set_route(\"List\", \"Project\");\n}\n\nfunction openInvoiceList(names, extraFilters) {\n  if (!names || !names.length) {\n    frappe.show_alert({ message: \"No invoices in this scope.\", indicator: \"orange\" });\n    return;\n  }\n  var routeOptions = { name: [\"in\", names] };\n  if (extraFilters) {\n    for (var k in extraFilters) routeOptions[k] = extraFilters[k];\n  }\n  frappe.route_options = routeOptions;\n  frappe.set_route(\"List\", \"Sales Invoice\");\n}\n\nfunction onCardClick(key) {\n  var b = payload.bucket_invoice_names || {};\n  if (key === \"status_total\") return openProjectList(\"total\");\n  if (key === \"status_ongoing\") return openProjectList(\"ongoing\");\n  if (key === \"status_completed\") return openProjectList(\"completed\");\n  if (key === \"money_revenue\") return openInvoiceList(payload.invoice_names_period || []);\n  if (key === \"money_outstanding\") return openInvoiceList(payload.invoice_names_outstanding || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_0_30\") return openInvoiceList(b[\"0-30\"] || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_31_60\") return openInvoiceList(b[\"31-60\"] || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_61_90\") return openInvoiceList(b[\"61-90\"] || [], { outstanding_amount: [\">\", 0] });\n  if (key === \"aging_90p\") return openInvoiceList(b[\"90+\"] || [], { outstanding_amount: [\">\", 0] });\n}\n\nfunction bindRowClicks() {\n  var rows = listWrap.querySelectorAll(\".psp-status-row\");\n  for (var i = 0; i < rows.length; i++) {\n    rows[i].addEventListener(\"click\", function () {\n      var s = this.getAttribute(\"data-status\");\n      if (s === \"Open\" || s === \"In Progress\") return openProjectList(\"ongoing\");\n      if (s === \"Completed\") return openProjectList(\"completed\");\n      if (s === \"Cancelled\") return openProjectList(\"cancelled\");\n    });\n  }\n}\n\nfunction bindCardClicks() {\n  var cards = financeWrap.querySelectorAll(\".psp-fin-card\");\n  for (var i = 0; i < cards.length; i++) {\n    cards[i].addEventListener(\"click\", function () {\n      onCardClick(this.getAttribute(\"data-key\"));\n    });\n  }\n}\n\nfunction bindTotalClick() {\n  totalEl.onclick = function () { openProjectList(\"total\"); };\n}\n\nfunction esc(s) { return frappe.utils.escape_html(String(s || \"\")); }\n\nfunction finCardHtml(item) {\n  return \"<div class=\\\"psp-fin-card\\\" data-key=\\\"\" + esc(item.key) + \"\\\" title=\\\"Click to open details\\\">\"\n    + \"<div class=\\\"psp-fin-label\\\">\" + esc(item.label) + \"</div>\"\n    + \"<div class=\\\"psp-fin-value \" + (item.cls === \"count\" ? \"psp-fin-count\" : \"\") + \"\\\">\" + esc(item.value) + \"</div>\"\n    + \"</div>\";\n}\n\nfunction statusRowHtml(label, val, color) {\n  return \"<div class=\\\"psp-status-row\\\" data-status=\\\"\" + esc(label) + \"\\\" title=\\\"Open \" + esc(label) + \" projects\\\">\"\n    + \"<span class=\\\"psp-dot\\\" style=\\\"background:\" + esc(color) + \"\\\"></span>\"\n    + \"<span class=\\\"psp-label\\\">\" + esc(label) + \"</span>\"\n    + \"<span class=\\\"psp-val\\\">\" + esc(val) + \"</span>\"\n    + \"</div>\";\n}\n\nfunction renderCards(data) {\n  var cts = data.counts || {};\n  var m = data.money || {};\n  var a = data.aging || {};\n  var cards = [\n    { key: \"status_total\", label: \"Total Projects\", value: c(cts.total), cls: \"count\" },\n    { key: \"status_ongoing\", label: \"Ongoing Projects\", value: c(cts.ongoing), cls: \"count\" },\n    { key: \"status_completed\", label: \"Completed Projects\", value: c(cts.completed), cls: \"count\" },\n    { key: \"money_revenue\", label: \"Total Revenue\", value: money(m.total_revenue), cls: \"money\" },\n    { key: \"money_outstanding\", label: \"Outstanding\", value: money(m.outstanding), cls: \"money\" },\n    { key: \"aging_0_30\", label: \"Aging 0-30\", value: money(a[\"0-30\"]), cls: \"money\" },\n    { key: \"aging_31_60\", label: \"Aging 31-60\", value: money(a[\"31-60\"]), cls: \"money\" },\n    { key: \"aging_61_90\", label: \"Aging 61-90\", value: money(a[\"61-90\"]), cls: \"money\" },\n    { key: \"aging_90p\", label: \"Aging 90+\", value: money(a[\"90+\"]), cls: \"money\" },\n  ];\n\n  var html = \"\";\n  for (var i = 0; i < cards.length; i++) html += finCardHtml(cards[i]);\n  financeWrap.innerHTML = html;\n  bindCardClicks();\n}\n\nfunction renderChart(labels, values, colors) {\n  chartWrap.innerHTML = \"\";\n  var total = 0;\n  for (var i = 0; i < values.length; i++) total += Number(values[i] || 0);\n  if (total <= 0) {\n    chartWrap.innerHTML = \"<div class=\\\"psp-empty-ring\\\">No project data</div>\";\n    return;\n  }\n  try {\n    new frappe.Chart(chartWrap, {\n      type: \"donut\",\n      height: 260,\n      showLegend: 0,\n      data: { labels: labels, datasets: [{ values: values }] },\n      colors: colors,\n      tooltipOptions: { formatTooltipY: function (v) { return c(v || 0) + \" project(s)\"; } },\n    });\n    var hide = chartWrap.querySelectorAll(\".graph-stats-container,.stats,.chart-legend\");\n    for (var j = 0; j < hide.length; j++) hide[j].style.display = \"none\";\n  } catch (e) {\n    console.error(\"Personal Project Pipeline chart error\", e);\n    chartWrap.innerHTML = \"<div class=\\\"psp-empty-ring\\\">Unable to render chart</div>\";\n  }\n}\n\nfunction render(data) {\n  var cts = data.counts || {};\n  var labels = [\"Open\", \"In Progress\", \"Completed\", \"Cancelled\"];\n  var openCount = Math.max(0, c(cts.total) - c(cts.ongoing) - c(cts.completed));\n  var values = [openCount, c(cts.ongoing), c(cts.completed), 0];\n  var colors = [\"#3b82f6\", \"#f59e0b\", \"#16a34a\", \"#ef4444\"];\n  payload = data || {};\n  totalEl.textContent = String(c(cts.total));\n\n  var statusHtml = \"\";\n  for (var i = 0; i < labels.length; i++) statusHtml += statusRowHtml(labels[i], c(values[i] || 0), colors[i]);\n  listWrap.innerHTML = statusHtml;\n\n  renderCards(data);\n  bindRowClicks();\n  bindTotalClick();\n  renderChart(labels, values, colors);\n}\n\nfunction load() {\n  frappe.call({ method: method, args: args() }).then(function (r) {\n    payload = r.message || {};\n    render(payload);\n  }).catch(function (e) {\n    console.error(\"Personal Project Pipeline load failed\", e);\n    chartWrap.innerHTML = \"<div class=\\\"psp-empty-ring\\\">Load failed</div>\";\n    listWrap.innerHTML = \"\";\n    financeWrap.innerHTML = \"\";\n  });\n}\n\nwindow.addEventListener(\"spd-personal-changed\", load);\nload();",
 "style": ".psp-card{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.psp-title{font-size:18px;font-weight:700}.psp-sub{color:var(--text-muted);font-size:12px;margin:2px 0 10px}.psp-body{display:grid;grid-template-columns:minmax(260px,1fr) minmax(220px,320px);gap:18px;align-items:center}.psp-chart{min-height:260px}.psp-empty-ring{display:flex;align-items:center;justify-content:center;min-height:220px;border:1px dashed #d1d5db;border-radius:10px;color:#64748b;font-size:13px}.psp-chart .graph-stats-container,.psp-chart .stats,.psp-chart .chart-legend{display:none!important}.psp-right{display:flex;align-items:center}.psp-status-list{width:100%;display:flex;flex-direction:column;gap:10px}.psp-status-row{display:grid;grid-template-columns:12px 1fr auto;gap:10px;align-items:center;padding:8px 10px;border:1px solid var(--gray-200);border-radius:8px;background:#fff;cursor:pointer;transition:all .15s ease}.psp-status-row:hover{border-color:var(--primary);background:#f8fafc;transform:translateY(-1px)}.psp-dot{width:12px;height:12px;border-radius:50%}.psp-label{font-size:14px;font-weight:600;color:var(--text-color)}.psp-val{font-size:14px;font-weight:700;color:var(--text-color)}.psp-finance-cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:12px}.psp-fin-card{border:1px solid #e2e8f0;border-radius:10px;padding:9px 10px;background:#fff;cursor:pointer;transition:all .15s ease}.psp-fin-card:hover{transform:translateY(-1px);border-color:var(--primary);background:#f8fafc}.psp-fin-label{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.3px}.psp-fin-value{font-size:18px;font-weight:800;color:#111827;line-height:1.25;margin-top:2px;word-break:break-word}.psp-fin-count{color:#2563eb}.psp-total{font-size:13px;color:var(--text-muted);text-align:right;margin-top:8px}.psp-total b{color:var(--text-color);cursor:pointer}.psp-total b:hover{text-decoration:underline}@media (max-width:1100px){.psp-finance-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:900px){.psp-body{grid-template-columns:1fr}.psp-right{order:2}.psp-left{order:1}}@media (max-width:640px){.psp-finance-cards{grid-template-columns:1fr}}"
}
