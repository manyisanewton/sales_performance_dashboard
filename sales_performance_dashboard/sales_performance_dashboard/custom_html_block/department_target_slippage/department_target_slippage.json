{
 "doctype": "Custom HTML Block",
 "name": "Department Target Slippage",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"dts-wrap\"><div class=\"dts-head\"><h3>Target Slippage Indicator</h3><p>Expected vs actual pace from Sales Targets and live sales.</p></div><div class=\"dts-controls\"><label>Mode</label><select class=\"dts-mode\"><option value=\"Daily\">Daily</option><option value=\"Monthly\" selected>Monthly</option></select></div><div class=\"dts-grid\"><div class=\"dts-card\"><div class=\"dts-label\" data-label=\"expected_label\">EXPECTED</div><div class=\"dts-value dts-blue\" data-key=\"expected_by_today\"></div></div><div class=\"dts-card\"><div class=\"dts-label\" data-label=\"actual_label\">ACTUAL</div><div class=\"dts-value dts-green\" data-key=\"actual_by_today\"></div></div><div class=\"dts-card\"><div class=\"dts-label\">SLIPPAGE</div><div class=\"dts-value\" data-key=\"slippage_amount\"></div></div><div class=\"dts-card\"><div class=\"dts-label\">PACE</div><div class=\"dts-value\" data-key=\"pace_pct\"></div></div><div class=\"dts-card\"><div class=\"dts-label\">STATUS</div><div class=\"dts-value\" data-key=\"status\"></div></div></div><div class=\"dts-chart-wrap\"><div class=\"dts-donut-area\"><div class=\"dts-donut\" title=\"Target Pace\"></div><div class=\"dts-donut-center\"><div class=\"dts-center-val\" data-center=\"pace\">0%</div><div class=\"dts-center-sub\">Pace</div></div></div><div class=\"dts-legend\"></div></div></div>",
 "script": "const method = \"sales_performance_dashboard.api.department_dashboard_api.get_department_target_slippage\";\nconst storageDepartment = 'spd_department_dashboard_department';\nconst storageDate = 'spd_department_reference_date';\nconst modeStorage = 'spd_department_slippage_mode';\n\nconst modeSelect = root_element.querySelector('.dts-mode');\nconst donutEl = root_element.querySelector('.dts-donut');\nconst legendEl = root_element.querySelector('.dts-legend');\nconst centerPaceEl = root_element.querySelector('[data-center=\"pace\"]');\n\nfunction asCurrency(v) { return format_currency(flt(v || 0)); }\nfunction asPercent(v) { return `${flt(v || 0, 2).toFixed(2)}%`; }\n\nfunction setValue(key, value) {\n  const el = root_element.querySelector(`[data-key=\"${key}\"]`);\n  if (!el) return;\n\n  if (key === 'expected_by_today' || key === 'actual_by_today' || key === 'slippage_amount') {\n    el.textContent = asCurrency(value);\n  } else if (key === 'pace_pct') {\n    el.textContent = asPercent(value);\n  } else {\n    el.textContent = value || '-';\n  }\n\n  if (key === 'slippage_amount') {\n    el.style.color = flt(value || 0) < 0 ? '#dc2626' : '#15803d';\n  }\n\n  if (key === 'status') {\n    const txt = (value || '').toLowerCase();\n    if (txt === 'ahead') el.style.color = '#15803d';\n    else if (txt === 'on pace') el.style.color = '#d97706';\n    else if (txt === 'behind') el.style.color = '#dc2626';\n    else el.style.color = '#475569';\n  }\n\n  if (key === 'pace_pct') {\n    el.style.color = flt(value || 0) >= 100 ? '#15803d' : (flt(value || 0) >= 95 ? '#d97706' : '#dc2626');\n  }\n}\n\nfunction setLabel(key, value) {\n  const el = root_element.querySelector(`[data-label=\"${key}\"]`);\n  if (el) el.textContent = (value || '').toUpperCase();\n}\n\nfunction renderDonut(payload) {\n  const labels = (payload.chart || {}).labels || ['Actual', 'Gap to Pace'];\n  const colors = (payload.chart || {}).colors || ['#3b82f6', '#f43f5e'];\n  const rawValues = (payload.chart || {}).values || [0, 0];\n\n  const values = rawValues.map((v) => Math.max(0, flt(v || 0)));\n  const total = values.reduce((a, b) => a + b, 0);\n\n  if (total <= 0) {\n    donutEl.style.background = 'conic-gradient(#e2e8f0 0 100%)';\n    legendEl.innerHTML = '<div class=\"dts-leg-item\"><span class=\"dts-dot\" style=\"background:#e2e8f0\"></span><span>No data</span></div>';\n    return;\n  }\n\n  let acc = 0;\n  const parts = values.map((v, i) => {\n    const pct = (v / total) * 100;\n    const start = acc;\n    const end = acc + pct;\n    acc = end;\n    return `${colors[i % colors.length]} ${start}% ${end}%`;\n  });\n  donutEl.style.background = `conic-gradient(${parts.join(',')})`;\n\n  const rows = values.map((v, i) => {\n    const pct = ((v / total) * 100).toFixed(1);\n    const label = frappe.utils.escape_html(labels[i] || `Part ${i + 1}`);\n    return `<div class=\"dts-leg-item\"><span class=\"dts-dot\" style=\"background:${colors[i % colors.length]}\"></span><span>${label}</span><span class=\"dts-leg-pct\">${pct}%</span><span class=\"dts-leg-val\">${asCurrency(v)}</span></div>`;\n  }).join('');\n  legendEl.innerHTML = rows;\n}\n\nfunction load() {\n  const department = localStorage.getItem(storageDepartment) || '';\n  const reference_date = localStorage.getItem(storageDate) || frappe.datetime.get_today();\n  const slippage_mode = modeSelect.value || 'Monthly';\n\n  frappe.call({ method, args: { department, slippage_mode, reference_date } }).then((r) => {\n    const payload = r.message || {};\n    setLabel('expected_label', payload.expected_label || 'Expected');\n    setLabel('actual_label', payload.actual_label || 'Actual');\n    setValue('expected_by_today', payload.expected_by_today);\n    setValue('actual_by_today', payload.actual_by_today);\n    setValue('slippage_amount', payload.slippage_amount);\n    setValue('pace_pct', payload.pace_pct);\n    setValue('status', payload.status);\n    centerPaceEl.textContent = asPercent(payload.pace_pct || 0);\n    renderDonut(payload);\n  });\n}\n\nmodeSelect.value = localStorage.getItem(modeStorage) || 'Monthly';\nmodeSelect.addEventListener('change', () => {\n  localStorage.setItem(modeStorage, modeSelect.value || 'Monthly');\n  load();\n});\n\nwindow.addEventListener('spd-department-changed', load);\nload();",
 "style": ".dts-wrap{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.dts-head h3{margin:0;font-size:18px;font-weight:700}.dts-head p{margin:2px 0 10px;font-size:12px;color:var(--text-muted)}.dts-controls{display:flex;align-items:center;gap:8px;margin-bottom:10px}.dts-controls label{font-size:12px;color:#475569;font-weight:600}.dts-controls select{height:34px;border:1px solid #d1d5db;border-radius:8px;padding:6px 10px;font-size:13px}.dts-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}.dts-card{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}.dts-label{font-size:11px;color:#52525b;font-weight:600;letter-spacing:.3px;margin-bottom:6px}.dts-value{font-size:22px;font-weight:700;line-height:1.1}.dts-blue{color:#1d4ed8}.dts-green{color:#15803d}.dts-chart-wrap{margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff;display:flex;gap:20px;align-items:center;flex-wrap:wrap}.dts-donut-area{position:relative;width:220px;height:220px;display:flex;align-items:center;justify-content:center}.dts-donut{width:220px;height:220px;border-radius:50%;background:conic-gradient(#e2e8f0 0 100%)}.dts-donut::after{content:'';position:absolute;inset:36px;border-radius:50%;background:#fff;box-shadow:inset 0 0 0 1px #eef2f7}.dts-donut-center{position:absolute;text-align:center;z-index:2}.dts-center-val{font-size:22px;font-weight:700;color:#1f2937}.dts-center-sub{font-size:11px;color:#64748b}.dts-legend{display:flex;flex-direction:column;gap:8px;min-width:260px;flex:1}.dts-leg-item{display:flex;align-items:center;gap:8px;font-size:13px}.dts-dot{width:10px;height:10px;border-radius:50%;display:inline-block}.dts-leg-pct{margin-left:auto;color:#334155;font-weight:600}.dts-leg-val{margin-left:8px;color:#64748b}@media (max-width:1400px){.dts-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (max-width:900px){.dts-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:640px){.dts-grid{grid-template-columns:1fr}.dts-value{font-size:19px}.dts-chart-wrap{justify-content:center}}"
}
