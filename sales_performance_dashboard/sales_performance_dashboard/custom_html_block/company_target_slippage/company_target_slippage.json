{
 "doctype": "Custom HTML Block",
 "name": "Company Target Slippage",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"cts-wrap\"><div class=\"cts-head\"><h3>Target Slippage Indicator</h3><p>Expected vs actual pace from Sales Targets and live sales.</p></div><div class=\"cts-grid\"><div class=\"cts-card\"><div class=\"cts-label\" data-label=\"expected_label\">EXPECTED</div><div class=\"cts-value cts-blue\" data-key=\"expected_by_today\"></div></div><div class=\"cts-card\"><div class=\"cts-label\" data-label=\"actual_label\">ACTUAL</div><div class=\"cts-value cts-green\" data-key=\"actual_by_today\"></div></div><div class=\"cts-card\"><div class=\"cts-label\">SLIPPAGE</div><div class=\"cts-value\" data-key=\"slippage_amount\"></div></div><div class=\"cts-card\"><div class=\"cts-label\">PACE</div><div class=\"cts-value\" data-key=\"pace_pct\"></div></div><div class=\"cts-card\"><div class=\"cts-label\">STATUS</div><div class=\"cts-value\" data-key=\"status\"></div></div></div><div class=\"cts-chart-wrap\"><div class=\"cts-donut-area\"><div class=\"cts-donut\" title=\"Target Pace\"></div><div class=\"cts-donut-center\"><div class=\"cts-center-val\" data-center=\"pace\">0%</div><div class=\"cts-center-sub\">Pace</div></div></div><div class=\"cts-legend\"></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_target_slippage';\nconst donutEl = root_element.querySelector('.cts-donut');\nconst legendEl = root_element.querySelector('.cts-legend');\nconst centerPaceEl = root_element.querySelector('[data-center=\"pace\"]');\n\nfunction asCurrency(v) { return format_currency(flt(v || 0)); }\nfunction asPercent(v) { return `${flt(v || 0, 2).toFixed(2)}%`; }\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n  };\n}\n\nfunction setValue(key, value) {\n  const el = root_element.querySelector(`[data-key=\\\"${key}\\\"]`);\n  if (!el) return;\n\n  if (key === 'expected_by_today' || key === 'actual_by_today' || key === 'slippage_amount') {\n    el.textContent = asCurrency(value);\n  } else if (key === 'pace_pct') {\n    el.textContent = asPercent(value);\n  } else {\n    el.textContent = value || '-';\n  }\n\n  if (key === 'slippage_amount') {\n    el.style.color = flt(value || 0) < 0 ? '#dc2626' : '#15803d';\n  }\n\n  if (key === 'status') {\n    const txt = (value || '').toLowerCase();\n    if (txt === 'ahead') el.style.color = '#15803d';\n    else if (txt === 'on pace') el.style.color = '#d97706';\n    else if (txt === 'behind') el.style.color = '#dc2626';\n    else el.style.color = '#475569';\n  }\n\n  if (key === 'pace_pct') {\n    el.style.color = flt(value || 0) >= 100 ? '#15803d' : (flt(value || 0) >= 95 ? '#d97706' : '#dc2626');\n  }\n}\n\nfunction setLabel(key, value) {\n  const el = root_element.querySelector(`[data-label=\\\"${key}\\\"]`);\n  if (el) el.textContent = (value || '').toUpperCase();\n}\n\nfunction renderDonut(payload) {\n  const labels = (payload.chart || {}).labels || ['Actual', 'Gap to Pace'];\n  const colors = (payload.chart || {}).colors || ['#3b82f6', '#f43f5e'];\n  const rawValues = (payload.chart || {}).values || [0, 0];\n\n  const values = rawValues.map((v) => Math.max(0, flt(v || 0)));\n  const total = values.reduce((a, b) => a + b, 0);\n\n  if (total <= 0) {\n    donutEl.style.background = 'conic-gradient(#e2e8f0 0 100%)';\n    legendEl.innerHTML = '<div class=\"cts-leg-item\"><span class=\"cts-dot\" style=\"background:#e2e8f0\"></span><span>No data</span></div>';\n    return;\n  }\n\n  let acc = 0;\n  const parts = values.map((v, i) => {\n    const pct = (v / total) * 100;\n    const start = acc;\n    const end = acc + pct;\n    acc = end;\n    return `${colors[i % colors.length]} ${start}% ${end}%`;\n  });\n  donutEl.style.background = `conic-gradient(${parts.join(',')})`;\n\n  const rows = values.map((v, i) => {\n    const p = ((v / total) * 100).toFixed(1);\n    const label = frappe.utils.escape_html(labels[i] || `Part ${i + 1}`);\n    return `<div class=\"cts-leg-item\"><span class=\"cts-dot\" style=\"background:${colors[i % colors.length]}\"></span><span>${label}</span><span class=\"cts-leg-pct\">${p}%</span><span class=\"cts-leg-val\">${asCurrency(v)}</span></div>`;\n  }).join('');\n  legendEl.innerHTML = rows;\n}\n\nfunction load() {\n  const filters = getFilters();\n  frappe.call({ method, args: { ...filters, slippage_mode: filters.view_mode } }).then((r) => {\n    const payload = r.message || {};\n    setLabel('expected_label', payload.expected_label || 'Expected');\n    setLabel('actual_label', payload.actual_label || 'Actual');\n    setValue('expected_by_today', payload.expected_by_today);\n    setValue('actual_by_today', payload.actual_by_today);\n    setValue('slippage_amount', payload.slippage_amount);\n    setValue('pace_pct', payload.pace_pct);\n    setValue('status', payload.status);\n    centerPaceEl.textContent = asPercent(payload.pace_pct || 0);\n    renderDonut(payload);\n  });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cts-wrap{background:#fff;border:1px solid var(--gray-200);border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.cts-head h3{margin:0;font-size:18px;font-weight:700}.cts-head p{margin:2px 0 10px;font-size:12px;color:var(--text-muted)}.cts-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}.cts-card{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}.cts-label{font-size:11px;color:#52525b;font-weight:600;letter-spacing:.3px;margin-bottom:6px}.cts-value{font-size:22px;font-weight:700;line-height:1.1}.cts-blue{color:#1d4ed8}.cts-green{color:#15803d}.cts-chart-wrap{margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff;display:flex;gap:20px;align-items:center;flex-wrap:wrap}.cts-donut-area{position:relative;width:220px;height:220px;display:flex;align-items:center;justify-content:center}.cts-donut{width:220px;height:220px;border-radius:50%;background:conic-gradient(#e2e8f0 0 100%)}.cts-donut::after{content:'';position:absolute;inset:36px;border-radius:50%;background:#fff;box-shadow:inset 0 0 0 1px #eef2f7}.cts-donut-center{position:absolute;text-align:center;z-index:2}.cts-center-val{font-size:22px;font-weight:700;color:#1f2937}.cts-center-sub{font-size:11px;color:#64748b}.cts-legend{display:flex;flex-direction:column;gap:8px;min-width:260px;flex:1}.cts-leg-item{display:flex;align-items:center;gap:8px;font-size:13px}.cts-dot{width:10px;height:10px;border-radius:50%;display:inline-block}.cts-leg-pct{margin-left:auto;color:#334155;font-weight:600}.cts-leg-val{margin-left:8px;color:#64748b}@media (max-width:1400px){.cts-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (max-width:900px){.cts-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (max-width:640px){.cts-grid{grid-template-columns:1fr}.cts-value{font-size:19px}.cts-chart-wrap{justify-content:center}}"
}
