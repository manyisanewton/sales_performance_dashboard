{
 "doctype": "Custom HTML Block",
 "name": "Company Payment Delay Cost",
 "module": "Sales Performance Dashboard",
 "private": 0,
 "html": "<div class=\"cpdc-wrap\"><div class=\"cpdc-head\"><h3>Payment Delay Cost</h3><p>Estimated financing cost of late collections for company scope from global filters.</p></div><div class=\"cpdc-main\"><div class=\"cpdc-gauge-pane\"><div class=\"cpdc-gauge\" data-gauge><div class=\"cpdc-gauge-inner\"><div class=\"cpdc-gauge-val\" data-k=\"cost_pct_of_overdue\">0.00%</div><div class=\"cpdc-gauge-lbl\">Delay Cost vs Overdue</div></div></div><div class=\"cpdc-kpis\"><div>Overdue Exposure: <b data-k=\"overdue_outstanding\">-</b></div><div>Estimated Delay Cost: <b data-k=\"estimated_delay_cost\">-</b></div><div>Cost/Day at Risk: <b data-k=\"daily_financing_cost\">-</b></div><div>Avg Overdue Days: <b data-k=\"avg_overdue_days\">-</b></div></div></div><div class=\"cpdc-bucket-pane\"><div class=\"cpdc-bucket-title\">Aging Buckets</div><div class=\"cpdc-buckets\" data-buckets></div></div></div><div class=\"cpdc-customers\"><div class=\"cpdc-bucket-title\">Top Customers by Delay Cost</div><div class=\"cpdc-customer-list\" data-customers></div></div></div>",
 "script": "const method = 'sales_performance_dashboard.api.company_dashboard_api.get_company_payment_delay_cost';\nconst gaugeEl = root_element.querySelector('[data-gauge]');\nconst bucketsEl = root_element.querySelector('[data-buckets]');\nconst customersEl = root_element.querySelector('[data-customers]');\n\nfunction cur(v) { return format_currency(v || 0); }\nfunction pct(v) { return `${flt(v || 0, 2).toFixed(2)}%`; }\n\nfunction setText(key, value) {\n  const el = root_element.querySelector(`[data-k=\\\"${key}\\\"]`);\n  if (!el) return;\n  if (key === 'cost_pct_of_overdue') el.textContent = pct(value);\n  else if (key === 'avg_overdue_days') el.textContent = `${flt(value || 0, 1).toFixed(1)} days`;\n  else el.textContent = cur(value);\n}\n\nfunction paintGauge(ratio) {\n  const capped = Math.max(0, Math.min(flt(ratio || 0), 100));\n  const angle = (capped / 100) * 360;\n  let color = '#16a34a';\n  if (capped >= 8) color = '#dc2626';\n  else if (capped >= 4) color = '#f59e0b';\n  gaugeEl.style.background = `conic-gradient(${color} ${angle}deg, #e5e7eb ${angle}deg)`;\n}\n\nfunction renderBuckets(rows) {\n  const data = rows || [];\n  const maxAmount = Math.max(1, ...data.map(r => flt(r.amount || 0)));\n  const colorBy = { '0-30': '#22c55e', '31-60': '#f59e0b', '61-90': '#fb7185', '90+': '#dc2626' };\n\n  bucketsEl.innerHTML = data.map((r) => {\n    const w = Math.max(3, (flt(r.amount || 0) / maxAmount) * 100);\n    const color = colorBy[r.label] || '#64748b';\n    return `<div class=\"cpdc-row\"><div class=\"cpdc-row-top\"><span class=\"cpdc-chip\" style=\"background:${color}\">${r.label}</span><span>${cur(r.amount)} | Cost ${cur(r.cost)} | ${cint(r.count || 0)} inv</span></div><div class=\"cpdc-bar\"><span style=\"width:${w}%;background:${color}\"></span></div></div>`;\n  }).join('');\n}\n\nfunction renderCustomers(rows) {\n  const data = rows || [];\n  const maxCost = Math.max(1, ...data.map(r => flt(r.cost || 0)));\n  customersEl.innerHTML = data.map((r) => {\n    const w = Math.max(8, (flt(r.cost || 0) / maxCost) * 100);\n    return `<div class=\"cpdc-c-row\"><div class=\"cpdc-c-name\">${frappe.utils.escape_html(r.customer || 'Unknown')}</div><div class=\"cpdc-c-track\"><span style=\"width:${w}%\"></span></div><div class=\"cpdc-c-val\">${cur(r.cost)} (${pct(r.cost_pct)})</div></div>`;\n  }).join('') || '<div class=\"cpdc-empty\">No delayed collections in this scope.</div>';\n}\n\nfunction getFilters() {\n  return {\n    company: localStorage.getItem('spd_company_dashboard_company') || '',\n    department: localStorage.getItem('spd_company_dashboard_department') || '',\n    view_mode: localStorage.getItem('spd_company_dashboard_view_mode') || 'Monthly',\n    reference_date: localStorage.getItem('spd_company_dashboard_reference_date') || frappe.datetime.get_today(),\n  };\n}\n\nfunction load() {\n  const args = getFilters();\n  frappe.call({ method, args: { ...args, top_limit: 6 } })\n    .then((r) => {\n      const d = r.message || {};\n      setText('cost_pct_of_overdue', d.cost_pct_of_overdue || 0);\n      setText('overdue_outstanding', d.overdue_outstanding || 0);\n      setText('estimated_delay_cost', d.estimated_delay_cost || 0);\n      setText('daily_financing_cost', d.daily_financing_cost || 0);\n      setText('avg_overdue_days', d.avg_overdue_days || 0);\n      paintGauge(d.cost_pct_of_overdue || 0);\n      renderBuckets(d.buckets || []);\n      renderCustomers(d.top_customers || []);\n    })\n    .catch(() => {\n      bucketsEl.innerHTML = '<div class=\"cpdc-empty\">Could not load delay cost data.</div>';\n      customersEl.innerHTML = '';\n    });\n}\n\nwindow.addEventListener('spd-company-changed', load);\nload();",
 "style": ".cpdc-wrap{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 3px 14px rgba(15,23,42,.05)}.cpdc-head h3{margin:0;font-size:22px;font-weight:700}.cpdc-head p{margin:4px 0 12px;color:#6b7280}.cpdc-main{display:grid;grid-template-columns:320px 1fr;gap:14px}.cpdc-gauge-pane{display:flex;flex-direction:column;gap:12px}.cpdc-gauge{width:220px;height:220px;border-radius:50%;margin:auto;display:flex;align-items:center;justify-content:center}.cpdc-gauge-inner{width:150px;height:150px;border-radius:50%;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:8px}.cpdc-gauge-val{font-size:28px;font-weight:800;color:#0f172a}.cpdc-gauge-lbl{font-size:11px;color:#6b7280}.cpdc-kpis{display:grid;gap:6px;font-size:12px;color:#475569}.cpdc-kpis b{color:#111827}.cpdc-bucket-title{font-size:16px;font-weight:700;margin-bottom:8px}.cpdc-buckets{display:grid;gap:10px}.cpdc-row-top{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:#334155}.cpdc-chip{display:inline-block;color:#fff;font-weight:700;border-radius:999px;padding:1px 8px;font-size:11px;min-width:52px;text-align:center}.cpdc-bar{width:100%;height:11px;background:#f1f5f9;border-radius:999px;overflow:hidden}.cpdc-bar span{display:block;height:100%;border-radius:999px}.cpdc-customers{margin-top:12px}.cpdc-customer-list{display:grid;gap:8px}.cpdc-c-row{display:grid;grid-template-columns:220px 1fr 170px;gap:10px;align-items:center;font-size:12px}.cpdc-c-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.cpdc-c-track{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}.cpdc-c-track span{display:block;height:100%;background:linear-gradient(90deg,#f97316,#dc2626);border-radius:999px}.cpdc-c-val{text-align:right;font-weight:600;color:#334155}.cpdc-empty{font-size:12px;color:#64748b;padding:6px 0}@media (max-width:1100px){.cpdc-main{grid-template-columns:1fr}.cpdc-gauge{margin:0 auto}.cpdc-c-row{grid-template-columns:150px 1fr 130px}}"
}
